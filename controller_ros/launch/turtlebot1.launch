<?xml version="1.0"?>
<!--
  TurtleBot1 + ROS Noetic 专用 Launch 文件
  
  使用方法:
    roslaunch controller_ros turtlebot1.launch
    roslaunch controller_ros turtlebot1.launch dashboard:=true
    roslaunch controller_ros turtlebot1.launch visualizer:=true
    roslaunch controller_ros turtlebot1.launch visualizer:=true camera_image:=/usb_cam/image_raw
    roslaunch controller_ros turtlebot1.launch dashboard:=true visualizer:=true
    roslaunch controller_ros turtlebot1.launch use_sim_time:=true
  
  默认行为:
    - dashboard 和 visualizer 默认关闭，需要时显式启用
    - 这样可以减少资源消耗，避免不必要的 PyQt5 依赖
  
  前置条件:
    1. TurtleBot1 驱动已启动: roslaunch turtlebot_bringup minimal.launch
    2. universal_controller 已安装 (pip install -e .)
    3. 轨迹发布器已启动 (发布 /nn/local_trajectory)
    4. (可选) 相机标定: roslaunch controller_ros trajectory_visualizer.launch calibration_mode:=true
-->
<launch>
  <!-- ========== 参数 ========== -->
  <arg name="use_sim_time" default="false" doc="Use simulation time"/>
  <arg name="dashboard" default="false" doc="Launch Dashboard GUI for monitoring"/>
  <arg name="visualizer" default="false" doc="Launch TurtleBot1 运行可视化界面 (轨迹、速度、手柄控制)"/>
  <arg name="camera_image" default="" doc="相机图像话题 (留空使用俯视图模式)"/>
  <arg name="calibration_file" default="" doc="单应性标定文件 (留空使用俯视图模式)"/>
  
  <!-- ========== 全局参数 ========== -->
  <param name="/use_sim_time" value="$(arg use_sim_time)"/>
  
  <!-- ========== 加载配置文件 ========== -->
  <!-- 基础配置 -->
  <rosparam file="$(find controller_ros)/config/controller_params.yaml" command="load"/>
  
  <!-- TurtleBot1 专用配置 (覆盖基础配置) -->
  <rosparam file="$(find controller_ros)/config/turtlebot1.yaml" command="load"/>
  
  <!-- 
  注意: 平台和控制频率已在 turtlebot1.yaml 中配置
  如需运行时覆盖，可使用:
    <param name="system/platform" value="differential"/>
    <param name="system/ctrl_freq" value="20"/>
  -->
  
  <!-- ========== 控制器节点 ========== -->
  <node pkg="controller_ros" type="controller_node.py" name="universal_controller_node" output="screen">
    <!-- 
    控制器节点说明:
    - 订阅 /odom, /nn/local_trajectory
    - 发布 /cmd_unified, /controller/diagnostics, /controller/state
    - 使用 TF2 查询 base_link -> odom 变换
    
    紧急停止:
    - 发送 std_msgs/Empty 到 /controller/emergency_stop 触发紧急停止
    - 通过 /controller/reset 服务清除紧急停止状态
    -->
  </node>

  <!-- ========== cmd_vel 适配器 ========== -->
  <node pkg="controller_ros" type="cmd_vel_adapter.py" name="cmd_vel_adapter" output="screen">
    <!-- 
    适配器说明:
    - 订阅 /cmd_unified (UnifiedCmd) 和 /joy_cmd_vel (Twist)
    - 发布到底盘话题 (配置在 turtlebot1.yaml 的 cmd_vel_adapter 块)
    - 以固定频率发布命令，解决底盘超时问题
    - 应用速度限制保护 TurtleBot1
    
    速度限制配置:
    - 统一从 constraints.v_max 和 constraints.omega_max 读取
    - 在 turtlebot1.yaml 中配置，确保与控制器一致
    -->
  </node>
  
  <!-- ========== Dashboard 节点 (可选) ========== -->
  <node pkg="controller_ros" type="dashboard_node.py" name="controller_dashboard" 
        output="screen" if="$(arg dashboard)">
    <!-- 
    Dashboard 可视化监控界面
    - 订阅 /controller/diagnostics 和 /controller/state
    - 显示实时状态、MPC 健康、一致性分析等
    - 需要 PyQt5: pip install PyQt5
    -->
  </node>
  
  <!-- ========== 运行可视化节点 (可选) ========== -->
  <group if="$(arg visualizer)">
    <!-- 加载可视化配置到全局命名空间 (visualizer_node.py 从这里读取) -->
    <rosparam file="$(find controller_ros)/config/visualizer_params.yaml" command="load"/>
    
    <node pkg="controller_ros" type="visualizer_node.py" name="turtlebot_visualizer" 
          output="screen">
      <!-- 相机和标定配置 - 仅在用户显式指定时覆盖 -->
      <param name="topics/camera_image" value="$(arg camera_image)" if="$(eval camera_image != '')"/>
      <param name="camera/calibration_file" value="$(arg calibration_file)" if="$(eval calibration_file != '')"/>
      <!-- 
      TurtleBot1 运行可视化界面
      功能:
      - 轨迹可视化: 俯视图或相机图像叠加 (需要单应性标定)
      - 速度监控: 实时显示底盘线速度和角速度
      - 手柄控制: Xbox 手柄控制机器人，LB 键切换控制模式
      
      相机模式:
      - 设置 camera_image 参数启用相机图像显示
      - 需要先运行标定: roslaunch controller_ros trajectory_visualizer.launch calibration_mode:=true
      
      依赖:
      - PyQt5: pip install PyQt5
      - 手柄驱动: sudo apt install ros-noetic-joy
      -->
    </node>
  </group>
</launch>


<!-- # 终端 1: TurtleBot 驱动
roslaunch turtlebot_bringup minimal.launch

# 终端 2: 控制器 (已包含 ACADOS 高性能求解器)
roslaunch controller_ros turtlebot1.launch

# 终端 3: 你的轨迹发布器
rosrun your_package trajectory_publisher.py -->
