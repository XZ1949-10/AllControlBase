# turtlebot1.yaml
# TurtleBot1 + ROS Noetic 专用配置
#
# 使用方法:
#   roslaunch controller_ros turtlebot1.launch
#
# 本配置针对 TurtleBot1 的特性进行了优化:
# - 较低的控制频率 (20Hz)
# - 保守的速度限制
# - 适应较低的传感器频率
# - 禁用 IMU (TurtleBot1 可能没有)
#
# =============================================================================
# 配置架构说明
# =============================================================================
# 
# 配置优先级 (从低到高):
#   1. universal_controller/config/*.py  - 默认配置 (代码中定义)
#   2. 本 YAML 文件                       - 平台特定覆盖
#   3. ROS 参数服务器                     - 运行时覆盖 (可选)
#
# 配置文件对应关系:
#   - system_config.py   -> system, watchdog, diagnostics, tracking
#   - safety_config.py   -> constraints, safety
#   - modules_config.py  -> consistency, transform, transition, backup
#   - mpc_config.py      -> mpc
#   - ekf_config.py      -> ekf
#
# 注意事项:
#   - 本文件只需要覆盖与默认值不同的配置项
#   - 未在此文件中定义的配置项将使用 universal_controller/config/ 中的默认值
#   - 添加新配置项时，请先在对应的 *_config.py 中定义默认值
#

# =============================================================================
# 系统配置
# =============================================================================
system:
  ctrl_freq: 20                   # 控制频率 (Hz) - TurtleBot1 建议 20Hz
  platform: "differential"        # 平台类型: 差速车

# =============================================================================
# ROS 节点配置
# =============================================================================
node:
  use_sim_time: false             # 是否使用仿真时间

# =============================================================================
# 话题配置
# =============================================================================
topics:
  # 输入话题
  odom: "/odom"                           # TurtleBot1 里程计
  imu: ""                                 # IMU (TurtleBot1 可能没有，留空)
  trajectory: "/nn/local_trajectory"      # 神经网络轨迹输入
  emergency_stop: "/controller/emergency_stop"
  
  # 输出话题
  cmd_unified: "/cmd_unified"             # 统一控制命令输出
  diagnostics: "/controller/diagnostics"  # 诊断信息输出
  state: "/controller/state"              # 控制器状态输出

# =============================================================================
# TF 配置
# =============================================================================
tf:
  source_frame: "base_footprint"  # TurtleBot1 机体坐标系 (TurtleBot 使用 base_footprint)
  target_frame: "odom"            # 里程计坐标系
  timeout_ms: 50                  # TF 查询超时 (适当放宽)
  buffer_warmup_timeout_sec: 5.0  # TF buffer 预热超时
  buffer_warmup_interval_sec: 0.2 # TF buffer 预热检查间隔
  expected_source_frames:         # 预期的源坐标系列表
    - "base_footprint"
    - "base_link"
    - ""

# =============================================================================
# 超时配置 (适应 TurtleBot1 较低传感器频率 + 2Hz 轨迹输出)
#
# 超时检测时序说明:
# ==================
# 1. 收到最后一条轨迹后，开始计时
# 2. 经过 traj_timeout_ms (1000ms) 后，标记轨迹超时
# 3. 超时后进入宽限期，继续使用旧轨迹
# 4. 宽限期 traj_grace_ms (500ms) 结束后，触发安全停止
#
# 时间线示例:
#   t=0ms    收到轨迹
#   t=1000ms 轨迹超时 (traj_timeout=true)，进入宽限期
#   t=1500ms 宽限期结束 (traj_grace_exceeded=true)，触发停止
#
# 总安全停止延迟 = traj_timeout_ms + traj_grace_ms = 1.5秒
#
# 注意: 0 或负数表示禁用该数据源的超时检测
# =============================================================================
watchdog:
  odom_timeout_ms: 500            # 里程计超时 (ms) - 放宽
  traj_timeout_ms: 1000           # 轨迹超时 (ms) - 2倍轨迹周期(~500ms)
  traj_grace_ms: 500              # 轨迹超时宽限期 (ms) - 超时后继续使用旧轨迹的时间
  imu_timeout_ms: -1              # IMU 超时 (ms) - 禁用 (TurtleBot1 无 IMU)
  startup_grace_ms: 5000          # 启动宽限期 (ms) - 延长到5秒，等待首条轨迹

# =============================================================================
# 诊断配置
# =============================================================================
diagnostics:
  publish_rate: 5                 # 诊断发布降频率

# =============================================================================
# MPC 配置 (针对 TurtleBot1 优化，使用 ACADOS 高性能求解器)
# 注意: 预测时域已调整以匹配网络输出 8 个轨迹点
# =============================================================================
mpc:
  horizon: 7                      # MPC 预测时域 - 必须 < 轨迹点数(8)，留1点余量
  horizon_degraded: 4             # 降级模式预测时域
  dt: 0.1                         # MPC 时间步长 (秒) - 必须匹配轨迹 dt_sec=0.1
  
  # 代价函数权重 (针对 TurtleBot1 调优)
  weights:
    position: 10.0                # 位置跟踪权重
    velocity: 1.0                 # 速度跟踪权重
    heading: 5.0                  # 航向跟踪权重
    # 控制输入权重 - 惩罚加速度/角加速度，实现平滑控制
    control_accel: 0.2            # 加速度控制权重 (稍高，减少抖动)
    control_alpha: 0.2            # 角加速度控制权重
  
  # ACADOS 高性能求解器配置 (必需)
  solver:
    nlp_max_iter: 50              # NLP 求解器最大迭代次数
    qp_solver: "PARTIAL_CONDENSING_HPIPM"  # QP 求解器类型 (高性能)
    integrator_type: "ERK"        # 积分器类型 (显式 Runge-Kutta)
    nlp_solver_type: "SQP_RTI"    # NLP 求解器类型 (实时迭代，最快)
  
  # MPC 健康监控参数 (放宽阈值，适应 TurtleBot1 较低控制频率)
  health_monitor:
    time_warning_thresh_ms: 20    # 求解时间警告阈值 (ms) - 放宽
    time_critical_thresh_ms: 40   # 求解时间临界阈值 (ms) - 放宽
    time_recovery_thresh_ms: 15   # 求解时间恢复阈值 (ms) - 放宽
    consecutive_warning_limit: 10 # 连续警告次数限制 - 更宽容
  
  # Fallback 求解器参数 (ACADOS 失败时使用)
  fallback:
    lookahead_steps: 3            # 前瞻步数
    heading_kp: 1.5               # 航向控制增益
    default_speed_ratio: 0.5      # 默认速度比例

# =============================================================================
# 速度约束 (TurtleBot1 安全限制)
# =============================================================================
constraints:
  v_max: 0.5                      # 最大线速度 (m/s)
  v_min: -0.2                     # 最小线速度 (m/s) - 倒车限制
  omega_max: 1.0                  # 最大角速度 (rad/s)
  a_max: 0.5                      # 最大加速度 (m/s²)
  alpha_max: 1.0                  # 最大角加速度 (rad/s²)

# =============================================================================
# 一致性检查配置 (提升平滑性)
# =============================================================================
consistency:
  kappa_thresh: 0.5               # 曲率一致性阈值
  v_dir_thresh: 0.8               # 速度方向一致性阈值
  temporal_smooth_thresh: 0.5     # 时序平滑度阈值
  alpha_min: 0.1                  # α 最小值
  weights:
    kappa: 0.3                    # 曲率权重 (原 curvature_weight)
    velocity: 0.3                 # 速度方向权重 (原 velocity_direction_weight)
    temporal: 0.4                 # 时序平滑权重 (原 temporal_smoothness_weight)

# =============================================================================
# 跟踪质量评估配置 (Dashboard 显示用)
# =============================================================================
tracking:
  # 误差阈值 (超过此值评分为 0)
  lateral_thresh: 0.3             # 横向误差阈值 (m)
  longitudinal_thresh: 0.5        # 纵向误差阈值 (m)
  heading_thresh: 0.5             # 航向误差阈值 (rad, ~28.6°)
  prediction_thresh: 0.5          # 预测误差阈值 (m)
  
  # 质量评分权重 (总和应为 1.0)
  weights:
    lateral: 0.4                  # 横向误差权重
    longitudinal: 0.4             # 纵向误差权重
    heading: 0.2                  # 航向误差权重
  
  # 评级阈值 (百分比)
  rating:
    excellent: 90                 # >= 90% 为优秀
    good: 70                      # >= 70% 为良好
    fair: 50                      # >= 50% 为一般，< 50% 为较差

# =============================================================================
# 安全配置
# =============================================================================
safety:
  v_stop_thresh: 0.05             # 停车速度阈值 (m/s)
  stopping_timeout: 5.0           # 停车超时时间 (秒)
  emergency_decel: 1.0            # 紧急减速度 (m/s²)
  
  # 低速保护
  low_speed:
    threshold: 0.1                # 低速阈值 (m/s)
    omega_limit: 1.0              # 低速角速度限制 (rad/s)
  
  # 安全裕度
  margins:
    velocity: 1.1                 # 速度裕度 (110%)
    acceleration: 1.5             # 加速度裕度 (150%)
  
  # 状态机配置
  #
  # Alpha (α) 说明:
  # ===============
  # α 是一致性检查器计算的轨迹可信度，范围 [0, 1]
  # - α = 1.0: 完全信任 soft head 输出的速度
  # - α = 0.0: 完全使用几何计算的速度
  #
  # 当轨迹不包含速度信息时 (如纯位置轨迹):
  # - 一致性检查器无法计算有意义的 α 值
  # - 应设置 alpha_disable_thresh = 0.0 禁用 α 检查
  # - 此时控制器将完全使用几何计算的速度
  #
  # TurtleBot1 配置说明:
  # - 网络输出的轨迹可能不包含速度信息
  # - 因此禁用 α 检查，避免误触发降级
  state_machine:
    alpha_disable_thresh: 0.0     # α 禁用阈值 (0 = 禁用 α 检查)
    alpha_recovery_value: 0.0     # α 恢复值 (禁用时无意义)
    alpha_recovery_thresh: 1      # α 恢复计数阈值 (禁用时无意义)

# =============================================================================
# 备份控制器配置 (Pure Pursuit)
# =============================================================================
backup:
  lookahead_dist: 0.5             # 前瞻距离 (m) (原 safety.backup_lookahead)
  min_lookahead: 0.3              # 最小前瞻距离 (m)
  max_lookahead: 1.5              # 最大前瞻距离 (m)
  kp_heading: 1.5                 # 航向增益

# =============================================================================
# EKF 状态估计配置
# =============================================================================
ekf:
  use_odom_orientation_fallback: true   # 使用里程计航向作为备选
  imu_motion_compensation: false        # IMU 运动补偿 (TurtleBot1 无 IMU)
  
  # 过程噪声 (TurtleBot1 调优)
  process_noise:
    position: 0.01                # 位置过程噪声
    velocity: 0.1                 # 速度过程噪声
    orientation: 0.05             # 航向过程噪声
    angular_velocity: 0.1         # 角速度过程噪声
  
  # 测量噪声
  measurement_noise:
    odom_position: 0.05           # 里程计位置噪声 (TurtleBot1 精度较低)
    odom_velocity: 0.1            # 里程计速度噪声

# =============================================================================
# 可视化配置 (visualizer)
# =============================================================================
# 启用方式: roslaunch controller_ros turtlebot1.launch visualizer:=true
# 
# 功能说明:
# - 轨迹可视化: 在俯视图上显示网络输出的轨迹
# - 速度监控: 实时显示底盘线速度和角速度
# - 手柄控制: Xbox 手柄控制机器人，LB 键切换控制模式
#
# 注意: 详细配置请参考 config/visualizer_params.yaml
visualizer:
  enabled: false                  # 是否默认启用 (launch 参数可覆盖)
  display:
    update_rate: 30               # GUI 刷新率 (Hz)
    velocity_history_sec: 10      # 速度历史显示时长 (秒)
  joystick:
    enable_button: 4              # LB 键 - 使能手柄控制
    max_linear: 0.5               # 手柄最大线速度 (m/s)
    max_angular: 1.0              # 手柄最大角速度 (rad/s)
    deadzone: 0.1                 # 摇杆死区
