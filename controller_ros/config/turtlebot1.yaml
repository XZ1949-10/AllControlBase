# turtlebot1.yaml
# TurtleBot1 + ROS Noetic 专用配置
#
# 使用方法:
#   roslaunch controller_ros turtlebot1.launch
#
# 本配置针对 TurtleBot1 的特性进行了优化:
# - 较低的控制频率 (20Hz)
# - 保守的速度限制
# - 适应较低的传感器频率
# - 禁用 IMU (TurtleBot1 没有)
#
# =============================================================================
# 配置架构说明
# =============================================================================
# 
# 配置优先级 (从低到高):
#   1. universal_controller/config/*.py  - 默认配置 (代码中定义)
#   2. 本 YAML 文件                       - 平台特定覆盖
#   3. ROS 参数服务器                     - 运行时覆盖 (可选)
#
# 原则:
#   - 本文件只覆盖与默认值不同的配置项
#   - 未定义的配置项使用 universal_controller/config/ 中的默认值
#   - 默认值参考: universal_controller/config/*_config.py
#

# =============================================================================
# 系统配置 - TurtleBot1 特有
# =============================================================================
system:
  ctrl_freq: 20                   # 控制频率 (Hz) - TurtleBot1 建议 20Hz (默认 50)
  platform: "differential"        # 平台类型: 差速车

# =============================================================================
# 话题配置 - TurtleBot1 特有
# 注意: 只覆盖与默认值不同的话题，其他使用 controller_params.yaml 默认值
# =============================================================================
topics:
  odom: "/odom"                           # TurtleBot1 里程计 (默认 /controller/input/odom)
  imu: ""                                 # 禁用 IMU (TurtleBot1 没有)
  trajectory: "/nn/local_trajectory"      # 神经网络轨迹输入 (默认 /controller/input/trajectory)
  cmd_unified: "/cmd_unified"             # 统一控制命令输出 (默认 /controller/cmd)
  # diagnostics, state, debug_path 使用默认值

# =============================================================================
# 超时配置 - 适应 TurtleBot1 较低传感器频率
#
# 超时检测时序:
#   t=0ms    收到轨迹
#   t=1000ms 轨迹超时，进入宽限期
#   t=1600ms 宽限期结束，触发安全停止
#
# 总安全停止延迟 = traj_timeout_ms + traj_grace_ms = 1.6秒
# =============================================================================
watchdog:
  traj_grace_ms: 600              # 轨迹宽限期 (默认 500) - 适应实际延迟 300-600ms

# =============================================================================
# 诊断配置
# =============================================================================
diagnostics:
  publish_rate: 5                 # 诊断发布降频率 (默认 10)

# =============================================================================
# MPC 配置 - 针对 TurtleBot1 优化
#
# 预测时域: 必须 < 轨迹点数(8)，留1点余量
# 时间步长: mpc.dt 会自动被 trajectory 模块继承，确保一致性
# =============================================================================
mpc:
  horizon: 7                      # MPC 预测时域 (默认 20)
  horizon_degraded: 4             # 降级模式预测时域 (默认 10)
  dt: 0.1                         # MPC 时间步长 (秒) - trajectory.default_dt_sec 自动继承此值
  
  # 代价函数权重 - 基于诊断结果调优
  weights:
    position: 15.0                # 位置跟踪权重 (默认 10.0)
    velocity: 6.0                 # 速度跟踪权重 (默认 1.0)
    heading: 8.0                  # 航向跟踪权重 (默认 5.0)
  
  # MPC 健康监控 - 放宽阈值适应较低控制频率
  health_monitor:
    time_warning_thresh_ms: 20    # 求解时间警告阈值 (默认 8)
    time_critical_thresh_ms: 40   # 求解时间临界阈值 (默认 15)
    time_recovery_thresh_ms: 15   # 求解时间恢复阈值 (默认 6)
    consecutive_warning_limit: 10 # 连续超时次数限制 (默认 3)

# =============================================================================
# 速度约束 - TurtleBot1 安全限制
# =============================================================================
constraints:
  v_max: 0.5                      # 最大线速度 (默认 2.0)
  v_min: -0.2                     # 最小线速度 (默认 0.0) - 允许倒车
  omega_max: 1.0                  # 最大角速度 (默认 2.0)
  omega_max_low: 0.5              # 低速时最大角速度 (默认 1.0)
  a_max: 0.5                      # 最大加速度 (默认 1.5)
  alpha_max: 1.5                  # 最大角加速度 (默认 3.0)

# =============================================================================
# 轨迹配置
#
# 注意: default_dt_sec 自动继承 mpc.dt，无需重复配置
# =============================================================================
trajectory:
  low_speed_thresh: 0.05          # 低速阈值 (默认 0.1) - 诊断建议降低

# =============================================================================
# 一致性检查配置
#
# 这些权重影响 alpha 值的计算，进而影响 soft/hard velocities 的混合比例。
# 当 alpha < alpha_min 时，会禁用 soft 模式，完全使用从轨迹点计算的速度。
#
# 权重说明 (使用加权几何平均，比例关系比绝对值更重要):
# - 默认权重: kappa=1.0, velocity=1.5, temporal=0.8 (速度方向优先)
# - TurtleBot1 权重: kappa=0.3, velocity=0.3, temporal=0.4 (时序平滑优先)
# - TurtleBot1 作为低速差速车，更注重运动平滑性
# =============================================================================
consistency:
  weights:
    kappa: 0.3                    # 曲率一致性权重 (默认 1.0)
    velocity: 0.3                 # 速度方向一致性权重 (默认 1.5)
    temporal: 0.4                 # 时序平滑度权重 (默认 0.8)

# =============================================================================
# 跟踪质量评估配置 - Dashboard 显示用
#
# TurtleBot1 差速车特性:
# - 横向误差更严格 (0.25 < 默认 0.3): 差速车不能侧向移动，横向偏差更难纠正
# - 纵向误差更宽松 (0.6 > 默认 0.5): 可通过调整速度补偿，容忍度更高
# =============================================================================
tracking:
  lateral_thresh: 0.25            # 横向误差阈值 (默认 0.3) - 差速车更严格
  longitudinal_thresh: 0.6        # 纵向误差阈值 (默认 0.5) - 差速车更宽松

# =============================================================================
# 安全配置
# =============================================================================
safety:
  emergency_decel: 1.0            # 紧急减速度 (默认 3.0) - TurtleBot1 更保守
  
  # 状态机配置 - 禁用 α 检查 (轨迹可能不包含速度信息)
  state_machine:
    mpc_recovery_tolerance: 1     # 最近 N 次中允许的失败次数 (默认 0)

# =============================================================================
# 备份控制器配置 (Pure Pursuit) - TurtleBot1 优化
# =============================================================================
backup:
  # 前瞻距离 - TurtleBot1 较小
  lookahead_dist: 0.5             # 前瞻距离 (默认 1.0)
  min_lookahead: 0.3              # 最小前瞻距离 (默认 0.5)
  max_lookahead: 1.5              # 最大前瞻距离 (默认 3.0)
  
  # 控制增益
  kp_heading: 2.0                 # 航向增益 (默认 1.5)

# =============================================================================
# 坐标变换配置
# =============================================================================
transform:
  source_frame: base_footprint    # TurtleBot1 机体坐标系 (默认 base_link)
  timeout_ms: 50                  # TF2 查询超时 (默认 10) - TurtleBot1 放宽
  
  # TF2 预热参数 - TurtleBot1 启动较慢
  buffer_warmup_timeout_sec: 5.0  # TF buffer 预热超时 (默认 2.0)
  buffer_warmup_interval_sec: 0.2 # TF buffer 预热检查间隔 (默认 0.1)
  
  # 注意: expected_source_frames 使用默认值即可
  # 默认值包含: base_link, base_footprint, base_link_0, '', odom
  # 其中 odom 表示轨迹已在里程计坐标系中，无需变换

# =============================================================================
# cmd_vel 适配器配置
#
# 配置统一性说明:
# - 速度限制统一从 constraints.v_max/omega_max 读取
# - 加速度限制统一从 constraints.a_max/alpha_max 读取 (不再重复定义)
# - 确保与控制器使用相同的约束值
#
# 话题说明:
# - 输入话题自动从 topics.cmd_unified 读取，无需重复配置
# - 仅配置 cmd_vel_adapter 特有的话题
#
# 速度变化率限制说明:
# - 对所有命令源生效（控制器和手柄），作为最后一道安全防线
# - 控制器输出通常已经过 VelocitySmoother 处理，rate limit 主要影响手柄命令
# - 设为 false 可禁用此功能（不推荐）
# =============================================================================
cmd_vel_adapter:
  publish_rate: 20.0              # 命令发布频率 (Hz)
  cmd_timeout: 0.5                # 命令超时 (秒)，适用于所有命令源（控制器和手柄）
  enable_rate_limit: true         # 启用速度变化率限制 (使用 constraints.a_max/alpha_max)
  
  # 话题配置 (仅 cmd_vel_adapter 特有话题)
  joy_topic: "/joy_cmd_vel"
  mode_topic: "/visualizer/control_mode"
  output_topic: "/mobile_base/commands/velocity"  # TurtleBot1 底盘话题
