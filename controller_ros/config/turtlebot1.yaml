# turtlebot1.yaml
# TurtleBot1 + ROS Noetic 专用配置
#
# 使用方法:
#   roslaunch controller_ros turtlebot1.launch
#
# 本配置针对 TurtleBot1 的特性进行了优化:
# - 较低的控制频率 (20Hz)
# - 保守的速度限制
# - 适应较低的传感器频率
# - 禁用 IMU (TurtleBot1 可能没有)
#
# =============================================================================
# 配置架构说明
# =============================================================================
# 
# 配置优先级 (从低到高):
#   1. universal_controller/config/*.py  - 默认配置 (代码中定义)
#   2. 本 YAML 文件                       - 平台特定覆盖
#   3. ROS 参数服务器                     - 运行时覆盖 (可选)
#
# 配置文件对应关系:
#   - system_config.py   -> system, watchdog, diagnostics, tracking
#   - safety_config.py   -> constraints, safety
#   - modules_config.py  -> consistency, transform, transition, backup
#   - mpc_config.py      -> mpc
#   - ekf_config.py      -> ekf
#
# 注意事项:
#   - 本文件只需要覆盖与默认值不同的配置项
#   - 未在此文件中定义的配置项将使用 universal_controller/config/ 中的默认值
#   - 添加新配置项时，请先在对应的 *_config.py 中定义默认值
#

# =============================================================================
# 系统配置
# =============================================================================
system:
  ctrl_freq: 20                   # 控制频率 (Hz) - TurtleBot1 建议 20Hz
  platform: "differential"        # 平台类型: 差速车
  gravity: 9.81                   # 重力加速度 (m/s²) - EKF 状态估计使用
  long_pause_threshold: 0.5       # 长时间暂停检测阈值 (秒) - 控制循环监控
  ekf_reset_threshold: 2.0        # EKF 重置阈值 (秒) - 超过此时间间隔重置 EKF

# =============================================================================
# 话题配置
# =============================================================================
topics:
  # 输入话题
  odom: "/odom"                           # TurtleBot1 里程计
  imu: ""                                 # IMU (TurtleBot1 可能没有，留空)
  trajectory: "/nn/local_trajectory"      # 神经网络轨迹输入
  emergency_stop: "/controller/emergency_stop"
  
  # 输出话题
  cmd_unified: "/cmd_unified"             # 统一控制命令输出
  diagnostics: "/controller/diagnostics"  # 诊断信息输出
  state: "/controller/state"              # 控制器状态输出

# =============================================================================
# TF 配置 (ROS TF2 特有参数)
# 
# 注意：坐标系名称（source_frame, target_frame）统一在 transform 配置中定义
# =============================================================================
tf:
  buffer_warmup_timeout_sec: 5.0  # TF buffer 预热超时
  buffer_warmup_interval_sec: 0.2 # TF buffer 预热检查间隔

# =============================================================================
# 超时配置 (适应 TurtleBot1 较低传感器频率 + 2Hz 轨迹输出)
#
# 超时检测时序说明:
# ==================
# 1. 收到最后一条轨迹后，开始计时
# 2. 经过 traj_timeout_ms (1000ms) 后，标记轨迹超时
# 3. 超时后进入宽限期，继续使用旧轨迹
# 4. 宽限期 traj_grace_ms (500ms) 结束后，触发安全停止
#
# 时间线示例:
#   t=0ms    收到轨迹
#   t=1000ms 轨迹超时 (traj_timeout=true)，进入宽限期
#   t=1500ms 宽限期结束 (traj_grace_exceeded=true)，触发停止
#
# 总安全停止延迟 = traj_timeout_ms + traj_grace_ms = 1.5秒
#
# 注意: 0 或负数表示禁用该数据源的超时检测
# [2025-12-30 调优] 诊断显示轨迹延迟 300-600ms，适当放宽
# =============================================================================
watchdog:
  odom_timeout_ms: 500            # 里程计超时 (ms) - 放宽
  traj_timeout_ms: 1000           # 轨迹超时 (ms) - 2倍轨迹周期(~500ms)
  traj_grace_ms: 600              # 轨迹超时宽限期 (ms) - 500→600，适应实际延迟
  imu_timeout_ms: -1              # IMU 超时 (ms) - 禁用 (TurtleBot1 无 IMU)
  startup_grace_ms: 5000          # 启动宽限期 (ms) - 延长到5秒，等待首条轨迹

# =============================================================================
# 诊断配置
# =============================================================================
diagnostics:
  publish_rate: 5                 # 诊断发布降频率

# =============================================================================
# MPC 配置 (针对 TurtleBot1 优化，使用 ACADOS 高性能求解器)
#
# 注意: 预测时域已调整以匹配网络输出 8 个轨迹点
# =============================================================================
mpc:
  horizon: 7                      # MPC 预测时域 - 必须 < 轨迹点数(8)，留1点余量
  horizon_degraded: 4             # 降级模式预测时域
  dt: 0.1                         # MPC 时间步长 (秒) - 必须匹配轨迹 dt_sec=0.1
  horizon_change_min_interval: 1.0  # Horizon 调整节流间隔 (秒) - 防止频繁重新初始化求解器
  
  # 代价函数权重 (针对 TurtleBot1 调优)
  # [2025-12-30 调优] 基于诊断结果优化:
  #   - 纵向误差 0.82m → 增加 velocity 权重
  #   - 横向误差 11.8cm → 增加 position 权重
  weights:
    position: 15.0                # 位置跟踪权重 (10→15, 减小横向误差)
    velocity: 6.0                 # 速度跟踪权重 (1→6, 减小纵向误差)
    heading: 8.0                  # 航向跟踪权重 (5→8, 改善转向跟踪)
    # 控制输入权重 - 惩罚加速度/角加速度，实现平滑控制
    control_accel: 0.1            # 加速度控制权重 (0.2→0.1, 允许更激进控制)
    control_alpha: 0.1            # 角加速度控制权重 (0.2→0.1)
  
  # ACADOS 高性能求解器配置 (必需)
  solver:
    nlp_max_iter: 50              # NLP 求解器最大迭代次数
    qp_solver: "PARTIAL_CONDENSING_HPIPM"  # QP 求解器类型 (高性能)
    integrator_type: "ERK"        # 积分器类型 (显式 Runge-Kutta)
    nlp_solver_type: "SQP_RTI"    # NLP 求解器类型 (实时迭代，最快)
  
  # MPC 健康监控参数 (放宽阈值，适应 TurtleBot1 较低控制频率)
  #
  # 三区间超时计数衰减策略:
  # ========================
  # - 警告区 (> time_warning_thresh): 累积超时计数，重置良好计数
  # - 恢复区 (< time_recovery_thresh): 累积良好计数，达到阈值后快速衰减超时计数
  # - 中间区 (recovery <= time <= warning): 重置良好计数，缓慢衰减超时计数
  #
  # 这种设计提供了滞后效应，防止在阈值边界频繁切换状态。
  #
  health_monitor:
    # 求解时间阈值 (三区间边界)
    time_warning_thresh_ms: 20    # 警告区下界 (ms) - 放宽
    time_critical_thresh_ms: 40   # 临界阈值 (ms) - 超过此值直接判定不健康
    time_recovery_thresh_ms: 15   # 恢复区上界 (ms) - 放宽
    
    # 连续计数阈值
    consecutive_warning_limit: 10 # 连续超时次数限制 - 更宽容
    consecutive_recovery_limit: 5 # 连续良好次数阈值 (达到后可恢复)
    
    # 超时计数衰减参数
    consecutive_good_for_decay: 2 # 连续良好次数达到此值后开始衰减超时计数
    timeout_decay_rate: 2         # 恢复区超时计数衰减速率 (每次减少的计数)
    middle_zone_decay_rate: 1     # 中间区超时计数衰减速率 (比恢复区慢，提供滞后)
    
    # 数值稳定性监控
    condition_number_thresh: 1.0e+08  # 条件数警告阈值
    condition_number_recovery: 1.0e+05  # 条件数恢复阈值
    kkt_residual_thresh: 0.001    # KKT 残差阈值
    recovery_multiplier: 2.0      # 备选恢复条件的倍数
  
  # Fallback 求解器参数 (ACADOS 失败时使用)
  # 注意: kp_heading, max_curvature, min_distance_thresh, min_turn_speed, default_speed_ratio
  # 统一从 backup 配置读取，确保与 Pure Pursuit 备份控制器行为一致
  fallback:
    lookahead_steps: 3            # 前瞻步数 (MPC fallback 特有)

# =============================================================================
# 速度约束 (TurtleBot1 安全限制)
# [2025-12-30 调优] 诊断发现 omega_max 被设为 0，导致无法转向
# =============================================================================
constraints:
  # 差速车主要约束
  v_max: 0.5                      # 最大线速度 (m/s)
  v_min: -0.2                     # 最小线速度 (m/s) - 倒车限制
  omega_max: 1.0                  # 最大角速度 (rad/s) - 确保不为0!
  omega_max_low: 0.5              # 低速时最大角速度 (rad/s)
  v_low_thresh: 0.1               # 低速阈值 (m/s)
  a_max: 0.5                      # 最大加速度 (m/s²)
  az_max: 1.0                     # 最大垂直加速度 (m/s²) - 差速车不用，但速度平滑器需要
  alpha_max: 1.5                  # 最大角加速度 (rad/s²) - 1.0→1.5，允许更快转向
  
  # 全向车/3D 平台约束 (差速车可忽略，但保留以支持平台切换)
  vx_max: 0.5                     # X 方向最大速度 (m/s)
  vx_min: -0.5                    # X 方向最小速度 (m/s)
  vy_max: 0.5                     # Y 方向最大速度 (m/s)
  vy_min: -0.5                    # Y 方向最小速度 (m/s)
  vz_max: 2.0                     # Z 方向最大速度 (m/s) - 3D 平台用

# =============================================================================
# 轨迹配置
# [2025-12-30 调优] 诊断建议降低 low_speed_thresh
#
# 坐标系配置说明:
# ===============
# 坐标系配置统一在 transform 配置块中定义:
# - transform.source_frame: 输入坐标系 (网络输出的局部坐标系)
# - transform.target_frame: 输出坐标系 (控制器工作坐标系)
# =============================================================================
trajectory:
  # 时间参数
  default_dt_sec: 0.1             # 默认时间步长 (秒) - 匹配网络输出，必须与 mpc.dt 一致
  min_dt_sec: 0.01                # 最小时间步长 (秒) - 验证用
  max_dt_sec: 1.0                 # 最大时间步长 (秒) - 验证用
  
  # 轨迹点数限制
  min_points: 2                   # 最小轨迹点数
  max_points: 100                 # 最大轨迹点数
  
  # 速度计算参数
  low_speed_thresh: 0.05          # 低速阈值 (m/s) - 0.1→0.05，诊断建议
  
  # 轨迹验证参数
  max_point_distance: 10.0        # 相邻点最大距离 (m)
  min_confidence: 0.0             # 最小置信度
  max_confidence: 1.0             # 最大置信度
  default_confidence: 0.9         # 默认置信度

# =============================================================================
# 一致性检查配置 (提升平滑性)
# =============================================================================
consistency:
  kappa_thresh: 0.5               # 曲率一致性阈值
  v_dir_thresh: 0.8               # 速度方向一致性阈值
  temporal_smooth_thresh: 0.5     # 时序平滑度阈值
  alpha_min: 0.1                  # α 最小值
  max_curvature: 10.0             # 曲率计算最大值限制 (1/m)
  temporal_window_size: 10        # 时序平滑度滑动窗口大小
  invalid_data_confidence: 0.5    # 数据无效时的保守置信度
  weights:
    kappa: 0.3                    # 曲率权重 (原 curvature_weight)
    velocity: 0.3                 # 速度方向权重 (原 velocity_direction_weight)
    temporal: 0.4                 # 时序平滑权重 (原 temporal_smoothness_weight)

# =============================================================================
# 跟踪质量评估配置 (Dashboard 显示用)
# [2025-12-30 调优] 根据实际误差调整阈值
# =============================================================================
tracking:
  # 误差阈值 (超过此值评分为 0)
  lateral_thresh: 0.25            # 横向误差阈值 (m) - 0.3→0.25，更早警告
  longitudinal_thresh: 0.6        # 纵向误差阈值 (m) - 0.5→0.6，适应实际情况
  heading_thresh: 0.5             # 航向误差阈值 (rad, ~28.6°)
  prediction_thresh: 0.5          # 预测误差阈值 (m)
  
  # 质量评分权重 (总和应为 1.0)
  weights:
    lateral: 0.4                  # 横向误差权重
    longitudinal: 0.4             # 纵向误差权重
    heading: 0.2                  # 航向误差权重
  
  # 评级阈值 (百分比)
  rating:
    excellent: 90                 # >= 90% 为优秀
    good: 70                      # >= 70% 为良好
    fair: 50                      # >= 50% 为一般，< 50% 为较差

# =============================================================================
# 安全配置
# =============================================================================
safety:
  v_stop_thresh: 0.05             # 停车速度阈值 (m/s)
  stopping_timeout: 5.0           # 停车超时时间 (秒)
  emergency_decel: 1.0            # 紧急减速度 (m/s²)
  velocity_margin: 1.1            # 速度限制裕度 (安全检查时的速度上限倍数)
  accel_margin: 1.5               # 加速度限制裕度 (安全检查时的加速度上限倍数)
  
  # 注意: 低速保护参数在 constraints 配置块中定义:
  # - omega_max_low: 低速时最大角速度
  # - v_low_thresh: 低速阈值
  
  # 加速度滤波参数 - 减少速度测量噪声导致的加速度估计噪声
  accel_filter_window: 3          # 滑动窗口大小
  accel_filter_alpha: 0.3         # 低通滤波系数 (正常运行)
  accel_filter_warmup_alpha: 0.5  # 滤波器预热期间的系数 (加速收敛)
  accel_filter_warmup_period: 3   # 滤波器预热期长度
  accel_warmup_margin_multiplier: 1.5  # 预热期间裕度倍数
  accel_warmup_margin_max: 2.0    # 预热期间裕度上限 (防止配置错误)
  accel_absolute_max_multiplier: 2.0   # 绝对加速度上限倍数 (硬性安全限制)
  min_dt_for_accel: 0.001         # 加速度计算最小时间间隔 (秒)
  max_dt_for_accel: 1.0           # 加速度计算最大时间间隔 (秒)
  vz_stop_thresh: 0.1             # 垂直停车速度阈值 (m/s) - 3D 平台用
  
  # 状态机配置
  #
  # Alpha (α) 说明:
  # ===============
  # α 是一致性检查器计算的轨迹可信度，范围 [0, 1]
  # - α = 1.0: 完全信任 soft head 输出的速度
  # - α = 0.0: 完全使用几何计算的速度
  #
  # 当轨迹不包含速度信息时 (如纯位置轨迹):
  # - 一致性检查器无法计算有意义的 α 值
  # - 应设置 alpha_disable_thresh = 0.0 禁用 α 检查
  # - 此时控制器将完全使用几何计算的速度
  #
  # TurtleBot1 配置说明:
  # - 网络输出的轨迹可能不包含速度信息
  # - 因此禁用 α 检查，避免误触发降级
  #
  # MPC 失败检测说明:
  # =================
  # 使用滑动窗口检测 MPC 是否持续失败:
  # - mpc_fail_window_size: 滑动窗口大小
  # - mpc_fail_thresh: 窗口内失败次数阈值
  # - mpc_fail_ratio_thresh: 失败率阈值
  # 当失败次数 >= mpc_fail_thresh 或失败率 >= mpc_fail_ratio_thresh 时，
  # 状态机会切换到 BACKUP_ACTIVE 状态
  #
  # MPC 恢复检测说明:
  # =================
  # 在 BACKUP_ACTIVE 状态下，检测 MPC 是否可以恢复:
  # - mpc_recovery_thresh: 连续成功次数阈值 (用于 MPC_DEGRADED → NORMAL)
  # - mpc_recovery_history_min: 最小历史记录数
  # - mpc_recovery_recent_count: 最近检查次数
  # - mpc_recovery_tolerance: 最近 N 次中允许的失败次数
  # - mpc_recovery_success_ratio: 整体成功率要求
  state_machine:
    alpha_disable_thresh: 0.0     # α 禁用阈值 (0 = 禁用 α 检查)
    alpha_recovery_value: 0.0     # α 恢复值 (禁用时无意义)
    alpha_recovery_thresh: 1      # α 恢复计数阈值 (禁用时无意义)
    
    # MPC 失败检测参数
    mpc_fail_window_size: 10      # MPC 失败检测滑动窗口大小
    mpc_fail_thresh: 3            # 窗口内失败次数阈值
    mpc_fail_ratio_thresh: 0.5    # 失败率阈值
    
    # MPC 恢复检测参数
    mpc_recovery_thresh: 5        # MPC 恢复计数阈值 (MPC_DEGRADED → NORMAL)
    mpc_recovery_history_min: 3   # 最小历史记录数
    mpc_recovery_recent_count: 5  # 最近检查次数
    mpc_recovery_tolerance: 1     # 最近 N 次中允许的失败次数
    mpc_recovery_success_ratio: 0.8  # 整体成功率要求
    
    # 状态超时监控参数 (新增)
    degraded_state_timeout: 30.0  # MPC_DEGRADED 状态超时 (秒)
    backup_state_timeout: 60.0    # BACKUP_ACTIVE 状态超时 (秒)
    enable_state_timeout_stop: false  # 是否启用状态超时自动停止 (默认仅告警)

# =============================================================================
# 备份控制器配置 (Pure Pursuit)
# [2025-12-30 调优] 增加航向增益，改善转向响应
# [2025-12-30 补充] 添加缺失的控制模式切换参数
#
# 控制模式切换逻辑说明:
# =====================
# Pure Pursuit 根据目标点相对于车辆的角度选择不同的控制策略:
#
#   目标点角度 (相对于车辆前进方向):
#   ┌─────────────────────────────────────────────────────────────┐
#   │  0° ~ pure_pursuit_angle_thresh (60°)  → Pure Pursuit 曲率控制
#   │  60° ~ heading_control_angle_thresh (90°) → 混合过渡区域
#   │  90° ~ 180° → 航向误差控制 (先转向再前进)
#   └─────────────────────────────────────────────────────────────┘
#
#   航向误差处理:
#   ┌─────────────────────────────────────────────────────────────┐
#   │  heading_error < heading_error_thresh (60°) → 边走边转
#   │  heading_error >= heading_error_thresh (60°) → 停止前进，原地转向
#   └─────────────────────────────────────────────────────────────┘
#
# =============================================================================
backup:
  # 前瞻距离参数
  lookahead_dist: 0.5             # 前瞻距离 (m)
  min_lookahead: 0.3              # 最小前瞻距离 (m)
  max_lookahead: 1.5              # 最大前瞻距离 (m)
  lookahead_ratio: 0.5            # 前瞻比例 (速度越快，前瞻越远)
  
  # 控制增益
  kp_heading: 2.0                 # 航向增益 (1.5→2.0)
  kp_z: 1.0                       # Z 方向增益 (3D 平台用)
  
  # 速度参数
  max_curvature: 5.0              # 最大曲率限制 (1/m)
  min_turn_speed: 0.1             # 最小转向速度 (m/s)
  default_speed_ratio: 0.5        # 无 soft 速度时的默认速度比例
  min_distance_thresh: 0.1        # 最小距离阈值 (m)
  
  # 控制模式切换参数
  heading_error_thresh: 1.047     # 航向误差阈值 (rad, ~60°) - 超过此值停止前进
  pure_pursuit_angle_thresh: 1.047  # Pure Pursuit 模式角度阈值 (rad, ~60°)
  heading_control_angle_thresh: 1.571  # 航向控制模式角度阈值 (rad, ~90°)
  
  # 低速过渡参数
  low_speed_transition_factor: 0.5  # 低速过渡区域因子
  curvature_speed_limit_thresh: 0.1 # 曲率速度限制阈值 (1/m)
  
  # 正后方处理参数 (防止目标点在正后方时的角速度跳变)
  rear_angle_thresh: 2.827        # 正后方检测阈值 (rad, ~162°, 0.9*π)
  rear_direction_min_thresh: 0.05 # 正后方转向判断最小阈值 (m)
  default_turn_direction: "left"  # 正后方默认转向方向 ("left" 或 "right")
  
  # 航向模式
  heading_mode: "follow_velocity" # 航向模式: follow_velocity, fixed, target_point, manual

# =============================================================================
# 坐标变换配置
# 
# 统一的坐标变换配置入口，包含：
# - 坐标系名称（source_frame, target_frame）
# - 算法层参数（降级、漂移估计等）
#
# 漂移估计说明:
# =============
# 当 TF2 不可用时，系统会使用里程计积分进行降级处理。
# 漂移估计用于估算降级期间累积的位置误差。
# - drift_estimation_enabled: false 表示禁用漂移估计（TurtleBot1 TF2 稳定）
# - max_accumulated_drift: 漂移累积上限，超过后停止累积（认为估计不可靠）
# =============================================================================
transform:
  source_frame: base_footprint    # TurtleBot1 机体坐标系
  target_frame: odom              # 里程计坐标系
  timeout_ms: 50                  # TF2 查询超时 (ms)
  fallback_duration_limit_ms: 500 # 降级持续限制 (ms) - 超过此值发出警告
  fallback_critical_limit_ms: 1000  # 临界降级限制 (ms) - 超过此值标记为临界
  
  # 漂移估计参数 (TF2 降级时使用)
  drift_estimation_enabled: false # 漂移估计开关 - TurtleBot1 TF2 稳定，禁用
  max_accumulated_drift: 1.0      # 漂移累积上限 (米) - 超过后停止累积
  drift_rate: 0.01                # 基础漂移率 (米/秒)
  drift_velocity_factor: 0.1      # 速度漂移因子 (每 1 m/s 增加的漂移率比例)
  max_drift_dt: 0.5               # 漂移估计最大时间间隔 (秒)
  drift_correction_thresh: 0.01   # 漂移校正阈值 (米/弧度)
  recovery_correction_enabled: true  # 恢复校正开关
  
  # 坐标系验证
  expected_source_frames:         # 预期的源坐标系列表
    - base_footprint
    - base_link
    - base_link_0
    - ''
    - odom
  warn_unexpected_frame: true

# =============================================================================
# 平滑过渡配置
# =============================================================================
transition:
  type: exponential               # 过渡类型
  tau: 0.1                        # 指数过渡时间常数 (秒)
  max_duration: 0.5               # 最大过渡时长 (秒)
  completion_threshold: 0.95      # 过渡完成阈值
  duration: 0.2                   # 线性过渡时长 (秒)

# =============================================================================
# EKF 状态估计配置
# =============================================================================
ekf:
  use_odom_orientation_fallback: true   # 使用里程计航向作为备选
  imu_motion_compensation: false        # IMU 运动补偿 (TurtleBot1 无 IMU)
  theta_covariance_fallback_thresh: 0.5 # 航向协方差回退阈值
  max_tilt_angle: 1.047                 # 最大倾斜角 (rad, ~60°)
  accel_freshness_thresh: 0.1           # 加速度新鲜度阈值 (秒)
  min_velocity_for_jacobian: 0.01       # 雅可比计算最小速度 (m/s)
  
  # 自适应参数
  adaptive:
    base_slip_thresh: 2.0         # 基础打滑阈值 (m/s²) - 固定值，不随底盘特性变化
    slip_velocity_factor: 0.5     # 打滑速度因子
    slip_covariance_scale: 10.0   # 打滑协方差缩放
    stationary_covariance_scale: 0.1  # 静止协方差缩放
    stationary_thresh: 0.05       # 静止阈值 (m/s)
    slip_probability_k_factor: 5.0    # 打滑概率 K 因子
    slip_history_window: 20       # 打滑历史窗口大小
  
  # 过程噪声 (TurtleBot1 调优)
  process_noise:
    position: 0.001               # 位置过程噪声
    velocity: 0.1                 # 速度过程噪声
    orientation: 0.01             # 航向过程噪声
    angular_velocity: 0.1         # 角速度过程噪声
    imu_bias: 0.0001              # IMU 偏置噪声
  
  # 测量噪声
  measurement_noise:
    odom_position: 0.01           # 里程计位置噪声
    odom_velocity: 0.1            # 里程计速度噪声
    odom_orientation: 0.01        # 里程计航向噪声
    odom_angular_velocity: 0.05   # 里程计角速度噪声
    imu_accel: 0.5                # IMU 加速度噪声
    imu_gyro: 0.01                # IMU 陀螺仪噪声
  
  # 异常检测
  anomaly_detection:
    drift_thresh: 0.1             # 漂移阈值 (m)
    jump_thresh: 0.5              # 跳变阈值 (m)
    covariance_explosion_thresh: 1000.0  # 协方差爆炸阈值
    innovation_anomaly_thresh: 10.0      # 新息异常阈值
  
  # 协方差配置
  covariance:
    min_eigenvalue: 1.0e-06       # 最小特征值
    initial_value: 0.1            # 初始值

# =============================================================================
# 可视化配置说明
# =============================================================================
# 启用方式: roslaunch controller_ros turtlebot1.launch visualizer:=true
# 
# 功能说明:
# - 轨迹可视化: 在俯视图上显示网络输出的轨迹
# - 速度监控: 实时显示底盘线速度和角速度
# - 手柄控制: Xbox 手柄控制机器人，LB 键切换控制模式
#
# 配置文件: config/visualizer_params.yaml
# 注意: visualizer 节点从 visualizer_params.yaml 读取配置，
#       而不是从本文件的 visualizer 配置块读取。

# =============================================================================
# cmd_vel 适配器配置
# =============================================================================
# cmd_vel_adapter 负责将 /cmd_unified 或 /joy_cmd_vel 转换为底盘命令
# 
# 架构说明:
# - 以固定频率发布命令，解决底盘 cmd_vel 超时问题
# - 手柄命令超时检测，确保手柄断开时机器人停止
#
# 速度限制说明:
# - 速度限制统一从 constraints.v_max/omega_max 读取
# - 不再单独配置 max_linear/max_angular，避免配置不一致
# =============================================================================
cmd_vel_adapter:
  # 发布配置
  publish_rate: 20.0              # 命令发布频率 (Hz) - 需要高于底盘超时频率
  joy_timeout: 0.5                # 手柄命令超时 (秒) - 超时后发布零速度
  
  # 速度变化率限制 (0 = 禁用，由 MPC 负责平滑)
  max_linear_accel: 0.0           # 最大线加速度 (m/s²)
  max_angular_accel: 0.0          # 最大角加速度 (rad/s²)
  
  # 话题配置
  input_topic: "/cmd_unified"               # 控制器输入
  joy_topic: "/joy_cmd_vel"                 # 手柄输入
  mode_topic: "/visualizer/control_mode"    # 模式切换
  output_topic: "/mobile_base/commands/velocity"  # TurtleBot1 底盘话题
