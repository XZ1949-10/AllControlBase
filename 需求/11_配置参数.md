# 通用控制器需求文档 - 配置参数

> 版本: v3.17.6

## 1. 默认配置常量

```python
"""
配置参数默认值常量定义

v3.17.5 新增: 集中定义所有默认值，便于维护和引用
"""

DEFAULT_CONFIG = {
    # 系统配置
    'system': {
        'ctrl_freq': 50,                    # 控制频率 (Hz)
        'platform': 'differential',         # 平台类型
    },
    
    # MPC 配置
    'mpc': {
        'horizon': 20,                      # 正常预测 horizon
        'horizon_degraded': 10,             # 降级时的 horizon
        'dt': 0.02,                         # 时间步长 (s)
        'weights': {
            'position': 10.0,               # 位置跟踪权重
            'velocity': 1.0,                # 速度跟踪权重
            'heading': 5.0,                 # 航向跟踪权重
            'control_accel': 0.1,           # 加速度控制量权重 (v3.18 重命名自 control_v)
            'control_alpha': 0.1,           # 角加速度控制量权重 (v3.18 重命名自 control_omega)
        },
        'health_monitor': {
            'time_warning_thresh_ms': 8,
            'time_critical_thresh_ms': 15,
            'time_recovery_thresh_ms': 6,
            'condition_number_thresh': 1e8,
            'condition_number_recovery': 1e5,
            'kkt_residual_thresh': 1e-3,
            'consecutive_warning_limit': 3,
            'consecutive_recovery_limit': 5,
        },
    },
    
    # 超时监控配置
    # 注意: 超时值 <= 0 表示禁用该数据源的超时检测
    'watchdog': {
        'odom_timeout_ms': 500,       # 里程计超时 (ms)，<=0 禁用
        'traj_timeout_ms': 1000,      # 轨迹超时 (ms)，<=0 禁用
        'traj_grace_ms': 500,         # 轨迹宽限期 (ms)
        'imu_timeout_ms': -1,         # IMU 超时 (ms)，<=0 禁用 (默认禁用，有 IMU 的平台需显式启用)
        'startup_grace_ms': 5000,     # 启动宽限期 (ms)
    },
    
    # 一致性检查配置
    'consistency': {
        'kappa_thresh': 0.5,
        'v_dir_thresh': 0.8,
        'temporal_smooth_thresh': 0.5,
        'low_speed_thresh': 0.1,
        'alpha_min': 0.1,
        'weights': {
            'kappa': 1.0,
            'velocity': 1.5,
            'temporal': 0.8,
        },
    },
    
    # 安全配置
    'safety': {
        'v_stop_thresh': 0.05,
        'vz_stop_thresh': 0.1,
        'stopping_timeout': 5.0,
        'emergency_decel': 3.0,
        'velocity_margin': 1.1,
        'accel_margin': 1.5,
        'state_machine': {
            'alpha_recovery_thresh': 5,
            'alpha_recovery_value': 0.3,
            'alpha_disable_thresh': 0.1,
            'mpc_recovery_thresh': 5,
        },
    },
    
    # 坐标变换配置
    'transform': {
        'target_frame': 'odom',
        'fallback_duration_limit_ms': 500,
        'fallback_critical_limit_ms': 1000,
        'tf2_timeout_ms': 10,
        'drift_estimation_enabled': True,
        'recovery_correction_enabled': True,
        'drift_rate': 0.01,
    },
    
    # 平滑过渡配置
    'transition': {
        'type': 'exponential',              # exponential 或 linear
        'tau': 0.1,                         # 指数过渡时间常数
        'max_duration': 0.5,                # 最大过渡时间
        'completion_threshold': 0.95,       # 完成阈值
        'duration': 0.2,                    # 线性过渡时间
    },
    
    # 备用控制器配置
    'backup': {
        'lookahead_dist': 1.0,
        'min_lookahead': 0.5,
        'max_lookahead': 3.0,
        'lookahead_ratio': 0.5,
        'kp_z': 1.0,
        'kp_heading': 1.5,
        'heading_mode': 'follow_velocity',  # follow_velocity, fixed, target_point, manual
        'dt': 0.02,
    },
    
    # 约束配置
    'constraints': {
        'v_max': 2.0,
        'v_min': 0.0,                       # 最小前进速度
        'omega_max': 2.0,
        'omega_max_low': 1.0,               # 低速时的角速度限制
        'v_low_thresh': 0.1,                # 低速阈值
        'a_max': 1.5,
        'az_max': 1.0,
        'alpha_max': 3.0,
        'vx_max': 1.5,                      # 全向车 x 方向最大速度
        'vx_min': -1.5,                     # 全向车 x 方向最小速度
        'vy_max': 1.5,                      # 全向车 y 方向最大速度
        'vy_min': -1.5,                     # 全向车 y 方向最小速度
        'vz_max': 2.0,
    },
    
    # EKF 配置
    'ekf': {
        'use_odom_orientation_fallback': True,
        'theta_covariance_fallback_thresh': 0.5,
        'imu_motion_compensation': False,
        'adaptive': {
            'base_slip_thresh': 2.0,
            'slip_velocity_factor': 0.5,
            'slip_covariance_scale': 10.0,
            'stationary_covariance_scale': 0.1,
            'stationary_thresh': 0.05,
        },
        'measurement_noise': {
            'odom_position': 0.01,
            'odom_velocity': 0.1,
            'imu_accel': 0.5,
            'imu_gyro': 0.01,
        },
        'process_noise': {
            'position': 0.001,
            'velocity': 0.1,
            'orientation': 0.01,
            'angular_velocity': 0.1,
            'imu_bias': 0.0001,
        },
        'anomaly_detection': {
            'drift_thresh': 0.1,
            'jump_thresh': 0.5,
        },
        'covariance': {
            'min_eigenvalue': 1e-6,
        },
    },
}


def get_config_value(config: Dict[str, Any], key_path: str, default: Any = None) -> Any:
    """
    从配置字典中获取值，支持点分隔的路径
    
    v3.17.5 新增: 统一的配置获取方法
    
    示例:
        get_config_value(config, 'mpc.horizon', 20)
        get_config_value(config, 'safety.state_machine.alpha_min', 0.1)
    """
    keys = key_path.split('.')
    value = config
    for key in keys:
        if isinstance(value, dict) and key in value:
            value = value[key]
        else:
            # 尝试从默认配置获取
            default_value = DEFAULT_CONFIG
            for k in keys:
                if isinstance(default_value, dict) and k in default_value:
                    default_value = default_value[k]
                else:
                    return default
            return default_value
    return value
```

## 2. 完整配置示例

```yaml
system:
  ctrl_freq: 50           # 控制频率 (Hz)
  platform: differential  # 平台类型: ackermann, differential, omni, quadrotor

mpc:
  horizon: 20             # 正常预测 horizon
  horizon_degraded: 10    # 降级时的 horizon
  dt: 0.02                # 时间步长 (s)
  
  weights:                # v3.17 新增: MPC 权重配置
    position: 10.0        # 位置跟踪权重
    velocity: 1.0         # 速度跟踪权重
    heading: 5.0          # 航向跟踪权重
    control_accel: 0.1    # 加速度控制量权重 (v3.18 重命名自 control_v)
    control_alpha: 0.1    # 角加速度控制量权重 (v3.18 重命名自 control_omega)
  
  health_monitor:
    time_warning_thresh_ms: 8
    time_critical_thresh_ms: 15
    time_recovery_thresh_ms: 6
    condition_number_thresh: 1e8
    condition_number_recovery: 1e5
    kkt_residual_thresh: 1e-3
    consecutive_warning_limit: 3
    consecutive_recovery_limit: 5

# 超时监控配置
# 注意: 超时值 <= 0 表示禁用该数据源的超时检测
watchdog:
  odom_timeout_ms: 500            # 里程计超时 (ms)，<=0 禁用
  traj_timeout_ms: 1000           # 轨迹超时 (ms)，<=0 禁用
  traj_grace_ms: 500              # 轨迹宽限期 (ms)
  imu_timeout_ms: -1              # IMU 超时 (ms)，<=0 禁用 (默认禁用)
  startup_grace_ms: 5000          # 启动宽限期 (ms)

consistency:
  kappa_thresh: 0.5
  v_dir_thresh: 0.8
  temporal_smooth_thresh: 0.5
  low_speed_thresh: 0.1
  alpha_min: 0.1
  weights:
    kappa: 1.0
    velocity: 1.5
    temporal: 0.8

safety:
  v_stop_thresh: 0.05
  vz_stop_thresh: 0.1
  stopping_timeout: 5.0
  emergency_decel: 3.0
  velocity_margin: 1.1
  accel_margin: 1.5
  
  state_machine:
    alpha_recovery_thresh: 5
    alpha_recovery_value: 0.3
    alpha_disable_thresh: 0.1
    mpc_recovery_thresh: 5
```


```yaml
transform:
  fallback_duration_limit_ms: 500
  fallback_critical_limit_ms: 1000
  tf2_timeout_ms: 10
  drift_estimation_enabled: true
  recovery_correction_enabled: true
  drift_rate: 0.01

transition:
  type: exponential
  tau: 0.1
  max_duration: 0.5
  completion_threshold: 0.95
  duration: 0.2

backup:
  lookahead_dist: 1.0
  min_lookahead: 0.5
  max_lookahead: 3.0
  lookahead_ratio: 0.5
  kp_z: 1.0
  kp_heading: 1.5
  heading_mode: follow_velocity
  dt: 0.02

constraints:
  v_max: 2.0
  v_min: 0.0
  omega_max: 2.0
  a_max: 1.5
  az_max: 1.0
  alpha_max: 3.0
  v_low_thresh: 0.1
  omega_max_low: 1.0
  vx_max: 1.5
  vx_min: -1.5
  vy_max: 1.5
  vy_min: -1.5
  vz_max: 2.0

ekf:
  # v3.17 新增: 航向备选配置
  use_odom_orientation_fallback: true
  theta_covariance_fallback_thresh: 0.5
  
  adaptive:
    base_slip_thresh: 2.0
    slip_velocity_factor: 0.5
    slip_covariance_scale: 10.0
    stationary_covariance_scale: 0.1
    stationary_thresh: 0.05
  
  measurement_noise:
    odom_position: 0.01
    odom_velocity: 0.1
    imu_accel: 0.5
    imu_gyro: 0.01
  
  process_noise:
    position: 0.001
    velocity: 0.1
    orientation: 0.01
    angular_velocity: 0.1
    imu_bias: 0.0001
  
  anomaly_detection:
    drift_thresh: 0.1
    jump_thresh: 0.5
  
  covariance:
    min_eigenvalue: 1e-6
  
  imu_motion_compensation: false
```

---

## 3. 配置参数说明

### 3.1 系统配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `system.ctrl_freq` | 50 | 控制频率 (Hz) |
| `system.platform` | differential | 平台类型: ackermann, differential, omni, quadrotor |

### 3.2 MPC 配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `mpc.horizon` | 20 | 正常预测 horizon |
| `mpc.horizon_degraded` | 10 | 降级时的 horizon |
| `mpc.dt` | 0.02 | 时间步长 (s) |
| `mpc.weights.position` | 10.0 | 位置跟踪权重 |
| `mpc.weights.velocity` | 1.0 | 速度跟踪权重 |
| `mpc.weights.heading` | 5.0 | 航向跟踪权重 |
| `mpc.weights.control_accel` | 0.1 | 加速度控制量权重 (v3.18 重命名自 control_v) |
| `mpc.weights.control_alpha` | 0.1 | 角加速度控制量权重 (v3.18 重命名自 control_omega) |
| `mpc.health_monitor.time_warning_thresh_ms` | 8 | 求解时间警告阈值 (ms) |
| `mpc.health_monitor.time_critical_thresh_ms` | 15 | 求解时间临界阈值 (ms) |
| `mpc.health_monitor.time_recovery_thresh_ms` | 6 | 求解时间恢复阈值 (ms) |
| `mpc.health_monitor.condition_number_thresh` | 1e8 | 条件数警告阈值 |
| `mpc.health_monitor.condition_number_recovery` | 1e5 | 条件数恢复阈值 |
| `mpc.health_monitor.kkt_residual_thresh` | 1e-3 | KKT 残差阈值 |
| `mpc.health_monitor.consecutive_warning_limit` | 3 | 连续警告次数限制 |
| `mpc.health_monitor.consecutive_recovery_limit` | 5 | 连续恢复次数限制 |

### 3.3 超时监控配置

注意: 超时值 <= 0 表示禁用该数据源的超时检测

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `watchdog.odom_timeout_ms` | 500 | Odom 超时阈值 (ms)，<=0 禁用 |
| `watchdog.traj_timeout_ms` | 1000 | 轨迹超时阈值 (ms)，<=0 禁用 |
| `watchdog.traj_grace_ms` | 500 | 轨迹超时后的宽限期 (ms) |
| `watchdog.imu_timeout_ms` | -1 | IMU 超时阈值 (ms)，<=0 禁用 (默认禁用，有 IMU 的平台需显式启用) |
| `watchdog.startup_grace_ms` | 5000 | 启动宽限期 (ms)，期间不判定超时 |

### 3.4 一致性检查配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `consistency.kappa_thresh` | 0.5 | 曲率一致性阈值 |
| `consistency.v_dir_thresh` | 0.8 | 速度方向一致性阈值 |
| `consistency.temporal_smooth_thresh` | 0.5 | 时序平滑性阈值 |
| `consistency.low_speed_thresh` | 0.1 | 低速阈值 (m/s)，影响航向变化率计算 |
| `consistency.alpha_min` | 0.1 | 最小 alpha 值，低于此值禁用 Soft |
| `consistency.weights.kappa` | 1.0 | 曲率一致性权重 |
| `consistency.weights.velocity` | 1.5 | 速度方向一致性权重 |
| `consistency.weights.temporal` | 0.8 | 时序平滑性权重 |

### 3.5 安全配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `safety.v_stop_thresh` | 0.05 | 停车速度阈值 (m/s) |
| `safety.vz_stop_thresh` | 0.1 | 垂直停车速度阈值 (m/s) |
| `safety.stopping_timeout` | 5.0 | STOPPING 状态超时 (s) |
| `safety.emergency_decel` | 3.0 | 紧急减速度 (m/s²) |
| `safety.velocity_margin` | 1.1 | 速度超限容差 (10%) |
| `safety.accel_margin` | 1.5 | 加速度超限容差 (50%) |
| `safety.state_machine.alpha_recovery_thresh` | 5 | alpha 恢复计数阈值 |
| `safety.state_machine.alpha_recovery_value` | 0.3 | alpha 恢复值阈值 |
| `safety.state_machine.alpha_disable_thresh` | 0.1 | alpha 禁用阈值 |
| `safety.state_machine.mpc_recovery_thresh` | 5 | MPC 恢复计数阈值 |

### 3.6 坐标变换配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `transform.target_frame` | odom | 目标坐标系 |
| `transform.fallback_duration_limit_ms` | 500 | TF2 降级警告时限 (ms) |
| `transform.fallback_critical_limit_ms` | 1000 | TF2 降级临界时限 (ms) |
| `transform.tf2_timeout_ms` | 10 | TF2 查询超时 (ms) |
| `transform.drift_estimation_enabled` | true | 是否启用漂移估计 |
| `transform.recovery_correction_enabled` | true | 是否启用恢复校正 |
| `transform.drift_rate` | 0.01 | 漂移率估计 (m/s) |

### 3.7 平滑过渡配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `transition.type` | exponential | 过渡类型: exponential, linear |
| `transition.tau` | 0.1 | 指数过渡时间常数 (s) |
| `transition.max_duration` | 0.5 | 最大过渡时间 (s) |
| `transition.completion_threshold` | 0.95 | 指数过渡完成阈值 |
| `transition.duration` | 0.2 | 线性过渡时间 (s) |

### 3.8 备用控制器配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `backup.lookahead_dist` | 1.0 | 基础前视距离 (m) |
| `backup.min_lookahead` | 0.5 | 最小前视距离 (m) |
| `backup.max_lookahead` | 3.0 | 最大前视距离 (m) |
| `backup.lookahead_ratio` | 0.5 | 前视距离速度比例 |
| `backup.kp_z` | 1.0 | 高度控制增益 |
| `backup.kp_heading` | 1.5 | 航向控制增益 |
| `backup.heading_mode` | follow_velocity | 航向模式: follow_velocity, fixed, target_point, manual |
| `backup.dt` | 0.02 | 时间步长 (s) |

### 3.9 约束配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `constraints.v_max` | 2.0 | 最大速度 (m/s) |
| `constraints.v_min` | 0.0 | 最小前进速度 (m/s)，用于 `_compute_target_velocity` |
| `constraints.omega_max` | 2.0 | 最大角速度 (rad/s) |
| `constraints.omega_max_low` | 1.0 | 低速时的角速度限制 (rad/s) |
| `constraints.v_low_thresh` | 0.1 | 低速阈值 (m/s) |
| `constraints.a_max` | 1.5 | 最大水平加速度 (m/s²) |
| `constraints.az_max` | 1.0 | 最大垂直加速度 (m/s²) |
| `constraints.alpha_max` | 3.0 | 最大角加速度 (rad/s²) |
| `constraints.vx_max` | 1.5 | 全向车 x 方向最大速度 (m/s) |
| `constraints.vx_min` | -1.5 | 全向车 x 方向最小速度 (m/s) |
| `constraints.vy_max` | 1.5 | 全向车 y 方向最大速度 (m/s) |
| `constraints.vy_min` | -1.5 | 全向车 y 方向最小速度 (m/s) |
| `constraints.vz_max` | 2.0 | 最大垂直速度 (m/s) |

### 3.10 EKF 配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `ekf.use_odom_orientation_fallback` | true | 是否使用 odom 航向作为备选 |
| `ekf.theta_covariance_fallback_thresh` | 0.5 | 触发航向备选的协方差阈值 |
| `ekf.imu_motion_compensation` | false | 是否启用 IMU 运动补偿 |
| `ekf.adaptive.base_slip_thresh` | 2.0 | 基础打滑检测阈值 (m/s²) |
| `ekf.adaptive.slip_velocity_factor` | 0.5 | 打滑阈值速度因子 |
| `ekf.adaptive.slip_covariance_scale` | 10.0 | 打滑时协方差缩放因子 |
| `ekf.adaptive.stationary_covariance_scale` | 0.1 | 静止时协方差缩放因子 |
| `ekf.adaptive.stationary_thresh` | 0.05 | 静止判定阈值 (m/s) |
| `ekf.measurement_noise.odom_position` | 0.01 | Odom 位置测量噪声 |
| `ekf.measurement_noise.odom_velocity` | 0.1 | Odom 速度测量噪声 |
| `ekf.measurement_noise.imu_accel` | 0.5 | IMU 加速度测量噪声 |
| `ekf.measurement_noise.imu_gyro` | 0.01 | IMU 陀螺仪测量噪声 |
| `ekf.process_noise.position` | 0.001 | 位置过程噪声 |
| `ekf.process_noise.velocity` | 0.1 | 速度过程噪声 |
| `ekf.process_noise.orientation` | 0.01 | 航向过程噪声 |
| `ekf.process_noise.angular_velocity` | 0.1 | 角速度过程噪声 |
| `ekf.process_noise.imu_bias` | 0.0001 | IMU 偏置过程噪声 |
| `ekf.anomaly_detection.drift_thresh` | 0.1 | IMU 漂移检测阈值 (rad/s) |
| `ekf.anomaly_detection.jump_thresh` | 0.5 | 位置跳变检测阈值 (m) |
| `ekf.covariance.min_eigenvalue` | 1e-6 | 协方差矩阵最小特征值 |
