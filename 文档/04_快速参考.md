# Universal Controller 快速参考

> 版本: v3.17.12 | 日期: 2024-12-22

## 安装

```bash
pip install numpy scipy PyYAML
pip install PyQt5 matplotlib  # Dashboard (可选)
```

## 基本使用

```python
from universal_controller import ControllerManager, DEFAULT_CONFIG
from universal_controller.tests.fixtures import create_test_trajectory, create_test_odom

config = DEFAULT_CONFIG.copy()
config['system']['platform'] = 'differential'

manager = ControllerManager(config)
manager.initialize_default_components()

odom = create_test_odom(x=0, y=0, theta=0, vx=0.5)
trajectory = create_test_trajectory(trajectory_type='sine')

cmd = manager.update(odom, trajectory)
print(f"vx={cmd.vx:.2f}, omega={cmd.omega:.2f}")

manager.shutdown()
```

---

## 平台类型

| 平台 | 配置值 | 输出 | 坐标系 |
|------|--------|------|--------|
| 差速车 | `differential` | vx, omega | base_link |
| 阿克曼车 | `ackermann` | vx, omega | base_link |
| 全向车 | `omni` | vx, vy, omega | odom |
| 四旋翼 | `quadrotor` | vx, vy, vz, omega | odom |

---

## 控制器状态 (ControllerState)

| 状态 | 值 | 说明 |
|------|-----|------|
| INIT | 0 | 初始化 |
| NORMAL | 1 | 正常运行 |
| SOFT_DISABLED | 2 | Soft 禁用 (α < 阈值) |
| MPC_DEGRADED | 3 | MPC 降级 |
| BACKUP_ACTIVE | 4 | 备用控制器激活 |
| STOPPING | 5 | 停车中 |
| STOPPED | 6 | 已停车 |

---

## 完整配置参数参考

### 系统配置 (system_config.py)

```python
# 系统基础配置
config['system'] = {
    'ctrl_freq': 50,              # 控制频率 (Hz) [1-1000]
    'platform': 'differential',   # 平台类型
    'gravity': 9.81,              # 重力加速度 (m/s²) [0.1-20.0]
    'long_pause_threshold': 0.5,  # 长时间暂停检测阈值 (秒) [0.01-10.0]
    'ekf_reset_threshold': 2.0,   # EKF 重置阈值 (秒) [0.1-60.0]
}

# 超时配置 (Watchdog)
# 注意: 超时值 <= 0 表示禁用该数据源的超时检测
config['watchdog'] = {
    'odom_timeout_ms': 500,       # 里程计超时 (ms)，<=0 禁用
    'traj_timeout_ms': 1000,      # 轨迹超时 (ms)，<=0 禁用
    'traj_grace_ms': 500,         # 轨迹宽限期 (ms)
    'imu_timeout_ms': -1,         # IMU 超时 (ms)，<=0 禁用 (默认禁用，有 IMU 的平台需显式启用)
    'startup_grace_ms': 5000,     # 启动宽限期 (ms)
}

# 诊断配置
config['diagnostics'] = {
    'topic': '/controller/diagnostics',  # 诊断话题名称
    'cmd_topic': '/cmd_unified',         # 控制命令话题名称
}
```

### MPC 配置 (mpc_config.py)

```python
config['mpc'] = {
    'horizon': 20,                # MPC 预测时域 [1-100]
    'horizon_degraded': 10,       # 降级时的预测时域 [1-100]
    'dt': 0.02,                   # 时间步长 (秒) [0.001-1.0]
    
    # 代价函数权重
    'weights': {
        'position': 10.0,         # 位置跟踪权重 [≥0]
        'velocity': 1.0,          # 速度跟踪权重 [≥0]
        'heading': 5.0,           # 航向跟踪权重 [≥0]
        'control_accel': 0.1,     # 加速度控制权重 [≥0] (惩罚加速度变化，实现平滑控制)
        'control_alpha': 0.1,     # 角加速度控制权重 [≥0] (惩罚角加速度变化)
    },
    
    # MPC 健康监控参数
    'health_monitor': {
        'time_warning_thresh_ms': 8,       # 求解时间警告阈值 (ms)
        'time_critical_thresh_ms': 15,     # 求解时间临界阈值 (ms)
        'time_recovery_thresh_ms': 6,      # 求解时间恢复阈值 (ms)
        'condition_number_thresh': 1e8,    # 条件数警告阈值
        'condition_number_recovery': 1e5,  # 条件数恢复阈值
        'kkt_residual_thresh': 1e-3,       # KKT 残差阈值
        'consecutive_warning_limit': 3,    # 连续警告次数限制
        'consecutive_recovery_limit': 5,   # 连续恢复次数限制
        'recovery_multiplier': 2.0,        # 备选恢复条件的倍数
        'consecutive_good_for_decay': 2,   # 连续良好次数达到此值后开始衰减
        'timeout_decay_rate': 2,           # 超时计数衰减速率
    },
    
    # Fallback 求解器参数
    'fallback': {
        'lookahead_steps': 3,              # 前瞻步数
        'heading_kp': 1.5,                 # 航向控制增益
        'max_curvature': 5.0,              # 最大曲率限制 (1/m)
        'min_distance_thresh': 0.1,        # 最小距离阈值 (m) [0.001-1.0]
        'min_turn_speed': 0.1,             # 阿克曼车辆最小转向速度 (m/s) [0.0-1.0]
        'default_speed_ratio': 0.5,        # 无 soft 速度时的默认速度比例 [0.0-1.0]
    },
    
    # ACADOS 求解器参数
    'solver': {
        'nlp_max_iter': 50,                # NLP 求解器最大迭代次数
        'qp_solver': 'PARTIAL_CONDENSING_HPIPM',
        'integrator_type': 'ERK',
        'nlp_solver_type': 'SQP_RTI',
    },
}
```

### 安全配置 (safety_config.py)

```python
# 运动约束配置
config['constraints'] = {
    'v_max': 2.0,           # 最大速度 (m/s) [0.01-100.0]
    'v_min': 0.0,           # 最小速度 (m/s)
    'omega_max': 2.0,       # 最大角速度 (rad/s) [0.01-50.0]
    'omega_max_low': 1.0,   # 低速时最大角速度 (rad/s)
    'v_low_thresh': 0.1,    # 低速阈值 (m/s)
    'a_max': 1.5,           # 最大加速度 (m/s²) [0.01-50.0]
    'az_max': 1.0,          # 最大垂直加速度 (m/s²)
    'alpha_max': 3.0,       # 最大角加速度 (rad/s²) [0.01-100.0]
    'vx_max': 1.5,          # X 方向最大速度 (m/s)
    'vx_min': -1.5,         # X 方向最小速度 (m/s)
    'vy_max': 1.5,          # Y 方向最大速度 (m/s)
    'vy_min': -1.5,         # Y 方向最小速度 (m/s)
    'vz_max': 2.0,          # Z 方向最大速度 (m/s)
}

# 安全监控配置
config['safety'] = {
    'v_stop_thresh': 0.05,      # 停车速度阈值 (m/s) [0.0-1.0]
    'vz_stop_thresh': 0.1,      # 垂直停车速度阈值 (m/s)
    'stopping_timeout': 5.0,    # 停车超时时间 (秒) [0.1-60.0]
    'emergency_decel': 3.0,     # 紧急减速度 (m/s²)
    'velocity_margin': 1.1,     # 速度限制裕度 [1.0-2.0]
    'accel_margin': 1.5,        # 加速度限制裕度 [1.0-3.0]
    
    # 加速度滤波参数
    'accel_filter_window': 3,        # 滑动窗口大小 [1-20]
    'accel_filter_alpha': 0.3,       # 低通滤波系数 [0.0-1.0]
    'accel_filter_warmup_alpha': 0.5,  # 滤波器预热期间的系数
    'accel_filter_warmup_period': 3,   # 滤波器预热期长度 [1-20]
    'min_dt_for_accel': 0.001,       # 加速度计算的最小时间间隔 (秒)
    'max_dt_for_accel': 1.0,         # 加速度计算的最大时间间隔 (秒)
    
    # 状态机配置
    'state_machine': {
        'alpha_recovery_thresh': 5,        # α 恢复计数阈值
        'alpha_recovery_value': 0.3,       # α 恢复值
        'alpha_disable_thresh': 0.1,       # α 禁用阈值
        'mpc_recovery_thresh': 5,          # MPC 恢复计数阈值
        'mpc_fail_window_size': 10,        # MPC 失败检测滑动窗口大小
        'mpc_fail_thresh': 3,              # 窗口内失败次数阈值
        'mpc_fail_ratio_thresh': 0.5,      # 失败率阈值
        'mpc_recovery_history_min': 3,     # MPC 恢复检测最小历史记录数
        'mpc_recovery_recent_count': 5,    # MPC 恢复检测最近检查次数
        'mpc_recovery_tolerance': 1,       # MPC 恢复检测容错次数
        'mpc_recovery_success_ratio': 0.8, # MPC 恢复检测成功率阈值 [0.0-1.0]
    },
}
```

### EKF 配置 (ekf_config.py)

```python
config['ekf'] = {
    # 航向备选配置
    'use_odom_orientation_fallback': True,      # 是否使用里程计航向作为备选
    'theta_covariance_fallback_thresh': 0.5,    # 航向协方差回退阈值
    'imu_motion_compensation': False,           # IMU 运动补偿
    
    # 自适应参数
    'adaptive': {
        'base_slip_thresh': 2.0,           # 打滑检测基础阈值 (m/s²)
        'slip_velocity_factor': 0.5,       # 速度相关因子
        'slip_covariance_scale': 10.0,     # 打滑时协方差放大倍数
        'stationary_covariance_scale': 0.1,  # 静止时协方差缩小倍数
        'stationary_thresh': 0.05,         # 静止检测阈值 (m/s)
        'slip_probability_k_factor': 5.0,  # 打滑概率 sigmoid 斜率因子
        'slip_history_window': 20,         # 打滑概率计算滑动窗口大小
    },
    
    # IMU 相关参数
    'max_tilt_angle': 1.047,               # IMU 姿态角有效性检查阈值 (rad, ~60°)
    'accel_freshness_thresh': 0.1,         # 加速度数据新鲜度阈值 (秒)
    
    # Jacobian 计算参数
    'min_velocity_for_jacobian': 0.01,     # Jacobian 计算的最小速度阈值 (m/s)
    
    # 测量噪声
    'measurement_noise': {
        'odom_position': 0.01,             # 里程计位置噪声 [1e-9-10.0]
        'odom_velocity': 0.1,              # 里程计速度噪声 [1e-9-10.0]
        'imu_accel': 0.5,                  # IMU 加速度噪声 [1e-9-10.0]
        'imu_gyro': 0.01,                  # IMU 陀螺仪噪声 [1e-9-10.0]
    },
    
    # 过程噪声
    'process_noise': {
        'position': 0.001,                 # 位置过程噪声 [1e-9-1.0]
        'velocity': 0.1,                   # 速度过程噪声 [1e-9-10.0]
        'orientation': 0.01,               # 航向过程噪声 [1e-9-1.0]
        'angular_velocity': 0.1,           # 角速度过程噪声 [1e-9-10.0]
        'imu_bias': 0.0001,                # IMU 偏置过程噪声 [1e-12-0.1]
    },
    
    # 异常检测参数
    'anomaly_detection': {
        'drift_thresh': 0.1,               # IMU 漂移检测阈值 (rad/s)
        'jump_thresh': 0.5,                # 位置跳变检测阈值 (m)
    },
    
    # 协方差参数
    'covariance': {
        'min_eigenvalue': 1e-6,            # 最小特征值 (保证正定)
        'initial_value': 0.1,              # 初始协方差对角线值
    },
}
```

### 姿态控制配置 (attitude_config.py)

```python
config['attitude'] = {
    # 物理参数
    'mass': 1.5,                    # 质量 (kg) [0.01-100.0]
    
    # 姿态角速度限制
    'roll_rate_max': 3.0,           # 最大滚转角速度 (rad/s)
    'pitch_rate_max': 3.0,          # 最大俯仰角速度 (rad/s)
    'yaw_rate_max': 2.0,            # 最大偏航角速度 (rad/s)
    
    # 姿态角限制
    'roll_max': 0.5,                # 最大滚转角 (rad, ~30°) [0.01-1.57]
    'pitch_max': 0.5,               # 最大俯仰角 (rad, ~30°) [0.01-1.57]
    
    # 速度控制增益
    'kp_vx': 0.5,                   # X 方向速度增益
    'kp_vy': 0.5,                   # Y 方向速度增益
    'kp_vz': 1.0,                   # Z 方向速度增益
    
    # 悬停 yaw 漂移补偿
    'hover_yaw_compensation': True,  # 是否启用悬停 yaw 补偿
    'hover_speed_thresh': 0.1,       # 悬停水平速度阈值 (m/s)
    'hover_vz_thresh': 0.05,         # 悬停垂直速度阈值 (m/s)
    'yaw_drift_rate': 0.001,         # yaw 漂移率 (rad/s)
    
    # 悬停检测滞后参数
    'hover_enter_factor': 1.0,       # 进入悬停的阈值因子
    'hover_exit_factor': 1.5,        # 退出悬停的阈值因子
    'hover_cmd_exit_factor': 2.0,    # 命令速度退出悬停的阈值因子
    'hover_debounce_time': 0.1,      # 悬停状态切换去抖动时间 (秒)
    
    # 推力限制 (归一化到悬停推力)
    'thrust_min': 0.1,               # 最小推力 [0.01-1.0]
    'thrust_max': 2.0,               # 最大推力 [1.0-10.0]
    'thrust_rate_max': 2.0,          # 推力变化率限制 (每秒)
    'min_thrust_factor': 0.1,        # 最小推力加速度因子
    'attitude_factor_min': 0.1,      # 姿态角饱和后推力重计算的最小因子
    
    # 其他参数
    'invert_pitch_sign': True,       # pitch 符号反转
    'dt': 0.02,                      # 时间步长 (秒)
}
```

### 其他模块配置 (modules_config.py)

```python
# 一致性检查配置
config['consistency'] = {
    'kappa_thresh': 0.5,              # 曲率一致性阈值 [0.0-10.0]
    'v_dir_thresh': 0.8,              # 速度方向一致性阈值 [0.0-1.0]
    'temporal_smooth_thresh': 0.5,    # 时序平滑度阈值
    'low_speed_thresh': 0.1,          # 低速阈值 (m/s)
    'alpha_min': 0.1,                 # α 最小值 [0.0-1.0]
    'max_curvature': 10.0,            # 曲率计算的最大值限制 (1/m)
    'temporal_window_size': 10,       # 时序平滑度计算的滑动窗口大小
    'weights': {
        'kappa': 1.0,                 # 曲率权重 [≥0]
        'velocity': 1.5,              # 速度方向权重 [≥0]
        'temporal': 0.8,              # 时序平滑权重 [≥0]
    },
}

# 坐标变换配置
config['transform'] = {
    'target_frame': 'odom',           # 目标坐标系 (控制器工作坐标系)
    'source_frame': 'base_link',      # 源坐标系 (网络输出轨迹坐标系)
    'fallback_duration_limit_ms': 500,   # 降级持续限制 (ms)
    'fallback_critical_limit_ms': 1000,  # 临界降级限制 (ms)
    'tf2_timeout_ms': 10,             # TF2 超时 (ms)
    'drift_estimation_enabled': True,    # 漂移估计开关
    'recovery_correction_enabled': True, # 恢复校正开关
    'drift_rate': 0.01,               # 漂移率 (米/秒)
    'max_drift_dt': 0.5,              # 漂移估计最大时间间隔 (秒)
    'drift_correction_thresh': 0.01,  # 漂移校正阈值 (米/弧度)
    'expected_source_frames': ['base_link', 'base_link_0', '', 'odom'],
    'warn_unexpected_frame': True,    # 对非期望坐标系发出警告
}

# 平滑过渡配置
config['transition'] = {
    'type': 'exponential',            # 过渡类型: 'exponential' 或 'linear'
    'tau': 0.1,                       # 指数过渡时间常数 (秒) [0.001-10.0]
    'max_duration': 0.5,              # 最大过渡时长 (秒) [0.01-10.0]
    'completion_threshold': 0.95,     # 过渡完成阈值 [0.5-1.0]
    'duration': 0.2,                  # 线性过渡时长 (秒)
}

# 备份控制器配置 (Pure Pursuit)
config['backup'] = {
    'lookahead_dist': 1.0,            # 前瞻距离 (m) [0.1-10.0]
    'min_lookahead': 0.5,             # 最小前瞻距离 (m) [0.01-5.0]
    'max_lookahead': 3.0,             # 最大前瞻距离 (m) [0.5-20.0]
    'lookahead_ratio': 0.5,           # 前瞻比例
    'kp_z': 1.0,                      # Z 方向增益
    'kp_heading': 1.5,                # 航向增益 [0.1-10.0]
    'heading_mode': 'follow_velocity',  # 航向模式
    'dt': 0.02,                       # 时间步长 (秒)
    
    # Pure Pursuit 控制参数
    'heading_error_thresh': 1.047,    # 航向误差阈值 (rad, ~60°)
    'pure_pursuit_angle_thresh': 1.047,  # Pure Pursuit 模式角度阈值
    'heading_control_angle_thresh': 1.571,  # 航向控制模式角度阈值 (~90°)
    'max_curvature': 5.0,             # 最大曲率限制 (1/m)
    'min_turn_speed': 0.1,            # 阿克曼车辆最小转向速度 (m/s)
    'default_speed_ratio': 0.5,       # 无 soft 速度时的默认速度比例
    
    # 低速过渡参数
    'low_speed_transition_factor': 0.5,  # 低速过渡区域因子
    
    # 曲率速度限制阈值
    'curvature_speed_limit_thresh': 0.1,  # 曲率阈值 (1/m)
    
    # 距离阈值
    'min_distance_thresh': 0.1,       # 最小距离阈值 (m)
    
    # 角速度变化率限制
    'omega_rate_limit': None,         # None 表示使用 alpha_max * dt
}
```

---

## 平台配置详解

| 平台 | 活跃维度 | 控制维度 | 约束 | 输出坐标系 |
|------|----------|----------|------|------------|
| ackermann | [0,1,3,6] px,py,vx,θ | [3,7] vx,ω | pz=0, vy=0, vz=0, curvature | base_link |
| differential | [0,1,3,6,7] px,py,vx,θ,ω | [3,7] vx,ω | pz=0, vy=0, vz=0 | base_link |
| omni | [0,1,3,4,6,7] px,py,vx,vy,θ,ω | [3,4,7] vx,vy,ω | pz=0, vz=0 | odom |
| quadrotor | [0,1,2,3,4,5,6,7] 全部 | [3,4,5,7] vx,vy,vz,ω | 无 | odom |

---

## 运行命令

```bash
# 运行示例
python -m universal_controller.main

# 启动 Dashboard
python -m universal_controller.dashboard.run_dashboard

# 运行所有测试
python universal_controller/tests/run_all_tests.py

# 运行单个测试
pytest universal_controller/tests/test_core.py -v
pytest universal_controller/tests/test_ekf_estimator.py -v
pytest universal_controller/tests/test_trackers.py -v

# 运行带覆盖率
pytest universal_controller/tests/ --cov=universal_controller --cov-report=html
```

---

## 测试文件列表

| 文件 | 测试内容 |
|------|----------|
| `test_core.py` | 核心数据类型和枚举 |
| `test_components.py` | 各组件单元测试 |
| `test_ekf_estimator.py` | EKF 状态估计器 |
| `test_trackers.py` | MPC 和 Pure Pursuit |
| `test_attitude_controller.py` | 四旋翼姿态控制 |
| `test_tf2_transform.py` | TF2 变换测试 |
| `test_coordinate_transform.py` | 坐标变换测试 |
| `test_config_validation.py` | 配置验证测试 |
| `test_config_effects.py` | 配置效果测试 |
| `test_diagnostics_input.py` | 诊断输入测试 |
| `test_diagnostics_publisher.py` | 诊断发布器测试 |
| `test_integration.py` | 端到端集成测试 |
| `test_bug_fixes.py` | Bug 修复回归测试 |
| `test_system_usability.py` | 系统可用性测试 |

---

## 诊断回调

```python
def on_diagnostics(diag):
    print(f"State: {diag['state']}")
    print(f"Alpha: {diag['consistency']['alpha_soft']:.3f}")
    print(f"MPC healthy: {diag['mpc_health']['is_healthy']}")
    print(f"Tracking error: {diag['tracking']['position_error']:.3f}")

manager.set_diagnostics_callback(on_diagnostics)
```

---

## 无人机姿态控制

```python
config['system']['platform'] = 'quadrotor'
manager = ControllerManager(config)
manager.initialize_default_components()

# 获取速度命令
cmd = manager.update(odom, trajectory)

# 计算姿态命令
attitude = manager.compute_attitude_command(
    cmd, 
    state, 
    yaw_mode='velocity'  # 或 'trajectory'
)

# 输出: attitude.roll, attitude.pitch, attitude.yaw, attitude.thrust
```

---

## 状态机转换图

```
INIT ──────────────────────────────────────────────────────────────┐
  │                                                                │
  │ (初始化完成)                                                    │
  ▼                                                                │
NORMAL ◄──────────────────────────────────────────────────────┐    │
  │                                                           │    │
  │ (α < 0.1)              (MPC 连续失败 ≥ 3)                  │    │
  ▼                        ▼                                  │    │
SOFT_DISABLED ────────► MPC_DEGRADED                          │    │
  │                        │                                  │    │
  │ (超时)                 │ (MPC 持续失败)                    │    │
  ▼                        ▼                                  │    │
  │                    BACKUP_ACTIVE                          │    │
  │                        │                                  │    │
  │ (停车请求)             │ (停车请求)                        │    │
  ▼                        ▼                                  │    │
STOPPING ◄─────────────────┘                                  │    │
  │                                                           │    │
  │ (速度 < 阈值)                                              │    │
  ▼                                                           │    │
STOPPED ──────────────────────────────────────────────────────┘    │
  │                                                                │
  │ (重新初始化)                                                    │
  └────────────────────────────────────────────────────────────────┘
```

---

## 常用数据类型

```python
from universal_controller.core.data_types import (
    Header,           # 消息头
    Point3D,          # 3D 点
    Trajectory,       # 轨迹
    ControlOutput,    # 控制输出
    EstimatorOutput,  # 状态估计输出
    ConsistencyResult,# 一致性结果
    TimeoutStatus,    # 超时状态
    MPCHealthStatus,  # MPC 健康状态
    DiagnosticsV2,    # 诊断消息
    AttitudeCommand,  # 姿态命令
)

from universal_controller.core.enums import (
    ControllerState,  # 控制器状态
    PlatformType,     # 平台类型
    TransformStatus,  # 变换状态
    HeadingMode,      # 航向模式
    TrajectoryMode,   # 轨迹模式
)

from universal_controller.core.diagnostics_input import (
    DiagnosticsInput, # 诊断输入 (强类型)
)

from universal_controller.core.velocity_smoother import (
    VelocitySmoother, # 速度平滑器
    clip_velocity,    # 速度限制函数
)
```

---

## 关键技术特性

| 特性 | 说明 |
|------|------|
| 单一时钟源 | 全局使用 `time.monotonic()` |
| 加速度滤波 | 一阶低通滤波 α=0.3，滑动窗口平均 |
| MPC fail counter | 带衰减机制 (成功时 -0.5)，防止状态抖动 |
| 悬停检测 | 滞回逻辑 (enter/exit factor)，防止频繁切换 |
| 四元数归一化 | 完整归一化，处理零向量 |
| Joseph 形式更新 | 数值稳定的 EKF 协方差更新 |
| 配置验证 | 范围检查 + 逻辑一致性检查 |
| 诊断发布 | 线程安全回调，numpy JSON 序列化 |
| 强类型诊断 | `DiagnosticsInput` 替代 `Dict[str, Any]` |

---

## 配置验证

```python
from universal_controller.config import validate_config, ConfigValidationError

config = DEFAULT_CONFIG.copy()
config['mpc']['horizon'] = -1  # 无效值

try:
    errors = validate_config(config, raise_on_error=True)
except ConfigValidationError as e:
    print(f"配置错误: {e}")

# 或不抛出异常
errors = validate_config(config, raise_on_error=False)
for key, msg in errors:
    print(f"  {key}: {msg}")
```

---

## 日志配置

```python
from universal_controller.core.logging_config import get_logger, configure_logging
import logging

# 配置全局日志级别
configure_logging(level=logging.DEBUG)

# 获取模块日志器
logger = get_logger(__name__)
logger.info("Message")
logger.warning("Warning")
logger.error("Error")

# 针对特定模块设置级别
logging.getLogger('universal_controller.estimator').setLevel(logging.DEBUG)
logging.getLogger('universal_controller.tracker').setLevel(logging.INFO)
```
