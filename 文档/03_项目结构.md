# Universal Controller 项目结构

> 版本: v3.17.12 | 日期: 2024-12-22

## 目录结构

```
universal_controller/
├── __init__.py              # 包入口，导出主要类
├── main.py                  # 主程序入口
├── requirements.txt         # 依赖列表
├── README.md                # 项目说明
│
├── config/                  # 配置模块 (10 个文件)
│   ├── __init__.py          # 配置模块入口
│   ├── default_config.py    # 默认配置合并和导出
│   ├── system_config.py     # 系统基础配置 (频率、超时、诊断)
│   ├── mpc_config.py        # MPC 配置 (时域、权重、健康监控)
│   ├── safety_config.py     # 安全配置 (约束、状态机、滤波)
│   ├── ekf_config.py        # EKF 配置 (噪声、自适应、异常检测)
│   ├── attitude_config.py   # 姿态控制配置 (四旋翼专用)
│   ├── modules_config.py    # 其他模块配置 (一致性、变换、过渡、备份)
│   ├── platform_config.py   # 平台配置 (differential/ackermann/omni/quadrotor)
│   └── validation.py        # 配置验证 (范围检查、逻辑一致性)
│
├── core/                    # 核心模块 (8 个文件)
│   ├── __init__.py          # 核心模块入口
│   ├── data_types.py        # 数据类型定义 (dataclass)
│   ├── enums.py             # 枚举定义 (ControllerState, PlatformType 等)
│   ├── interfaces.py        # 抽象接口定义 (ABC)
│   ├── ros_compat.py        # ROS 兼容层 (支持 ROS 和独立模式)
│   ├── velocity_smoother.py # 速度平滑工具 (加速度限制)
│   ├── diagnostics_input.py # 诊断输入数据类型 (强类型替代 Dict)
│   └── logging_config.py    # 统一日志配置
│
├── estimator/               # 状态估计
│   ├── __init__.py
│   └── adaptive_ekf.py      # 自适应 EKF 状态估计器 (11 维状态)
│
├── tracker/                 # 轨迹跟踪
│   ├── __init__.py
│   ├── mpc_controller.py    # MPC 控制器 (ACADOS + Fallback)
│   ├── pure_pursuit.py      # Pure Pursuit 备用控制器
│   └── attitude_controller.py # 无人机姿态控制器 (悬停检测)
│
├── consistency/             # 一致性检查
│   ├── __init__.py
│   └── weighted_analyzer.py # 加权几何平均一致性分析器
│
├── safety/                  # 安全模块
│   ├── __init__.py
│   ├── safety_monitor.py    # 安全监控器 (加速度滤波 α=0.3)
│   ├── state_machine.py     # 7 级状态机 (MPC fail counter + decay)
│   └── timeout_monitor.py   # 超时监控器 (monotonic clock)
│
├── health/                  # 健康监控
│   ├── __init__.py
│   └── mpc_health_monitor.py # MPC 健康监控器 (时间/条件数/KKT)
│
├── transition/              # 平滑过渡
│   ├── __init__.py
│   └── smooth_transition.py # 平滑过渡控制器 (指数/线性)
│
├── transform/               # 坐标变换
│   ├── __init__.py
│   └── robust_transformer.py # 鲁棒坐标变换器 (TF2 + Fallback)
│
├── manager/                 # 控制器管理
│   ├── __init__.py
│   └── controller_manager.py # 控制器管理器 (主控制循环)
│
├── diagnostics/             # 诊断模块 (新增)
│   ├── __init__.py
│   └── publisher.py         # 诊断发布器 (ROS 话题 + 回调)
│
├── mock/                    # 模拟数据模块
│   ├── __init__.py
│   ├── ros_mock.py          # ROS 模拟实现 (MockRospy, MockTF2)
│   ├── data_mock.py         # 模拟数据类型
│   ├── diagnostics_mock.py  # 模拟诊断数据生成
│   └── test_data_generator.py # 测试数据生成器
│
├── msg/                     # ROS 消息定义
│   ├── __init__.py
│   ├── CMakeLists.txt       # ROS 构建配置
│   ├── package.xml          # ROS 包配置
│   ├── DiagnosticsV2.msg    # 诊断消息
│   ├── LocalTrajectoryV4.msg # 轨迹消息
│   └── UnifiedCmd.msg       # 统一控制命令
│
├── dashboard/               # 可视化界面
│   ├── __init__.py
│   ├── main_window.py       # 主窗口
│   ├── data_source.py       # 数据源接口
│   ├── models.py            # 数据模型定义
│   ├── styles.py            # 样式定义 (颜色、字体)
│   ├── run_dashboard.py     # 启动脚本
│   ├── panels/              # 面板组件 (14 个)
│   │   ├── __init__.py
│   │   ├── system_info.py   # 系统信息
│   │   ├── state_panel.py   # 状态面板
│   │   ├── mpc_health.py    # MPC 健康
│   │   ├── degradation.py   # 降级状态
│   │   ├── timeout.py       # 超时监控
│   │   ├── consistency.py   # 一致性分析
│   │   ├── safety.py        # 安全约束
│   │   ├── trajectory.py    # 轨迹信息
│   │   ├── trajectory_view.py # 轨迹可视化
│   │   ├── tracking.py      # 跟踪误差
│   │   ├── control.py       # 控制输出
│   │   ├── estimator.py     # 状态估计
│   │   ├── statistics.py    # 运行统计
│   │   └── alerts.py        # 警告提醒
│   └── widgets/             # 自定义控件 (3 个)
│       ├── __init__.py
│       ├── progress_bar.py  # 进度条
│       ├── status_led.py    # 状态指示灯
│       └── state_indicator.py # 状态指示器
│
├── visualization/           # 可视化扩展 (预留)
│
└── tests/                   # 测试模块 (16 个文件)
    ├── __init__.py
    ├── run_all_tests.py             # 运行所有测试
    ├── test_core.py                 # 核心模块测试
    ├── test_components.py           # 组件单元测试
    ├── test_integration.py          # 集成测试
    ├── test_tf2_transform.py        # TF2 变换测试
    ├── test_coordinate_transform.py # 坐标变换测试
    ├── test_attitude_controller.py  # 姿态控制器测试
    ├── test_ekf_estimator.py        # EKF 估计器测试
    ├── test_trackers.py             # 轨迹跟踪器测试
    ├── test_config_validation.py    # 配置验证测试
    ├── test_config_effects.py       # 配置效果测试
    ├── test_diagnostics_input.py    # 诊断输入测试
    ├── test_diagnostics_publisher.py # 诊断发布器测试
    ├── test_bug_fixes.py            # Bug 修复回归测试
    └── test_system_usability.py     # 系统可用性测试
```

---

## 模块依赖关系

```
                    ┌─────────────────────────────────────┐
                    │         ControllerManager           │
                    │      (manager/controller_manager.py)│
                    └─────────────────────────────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ StateEstimator  │       │ TrajectoryTracker│       │ SafetyMonitor   │
│ (estimator/)    │       │ (tracker/)       │       │ (safety/)       │
└─────────────────┘       └─────────────────┘       └─────────────────┘
          │                           │                           │
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ ConsistencyChecker│     │ CoordTransformer │       │ StateMachine    │
│ (consistency/)  │       │ (transform/)     │       │ (safety/)       │
└─────────────────┘       └─────────────────┘       └─────────────────┘
          │                           │                           │
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ MPCHealthMonitor│       │ SmoothTransition │       │ TimeoutMonitor  │
│ (health/)       │       │ (transition/)    │       │ (safety/)       │
└─────────────────┘       └─────────────────┘       └─────────────────┘
          │                           │                           │
          └───────────────────────────┼───────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │       DiagnosticsPublisher          │
                    │      (diagnostics/publisher.py)     │
                    └─────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │           Core Module               │
                    │  (core/data_types, enums, interfaces)│
                    └─────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │         Config Module               │
                    │    (config/*.py - 10 个配置文件)     │
                    └─────────────────────────────────────┘
```

---

## 配置模块详细说明

### 配置文件结构

| 文件 | 功能 | 主要配置项 |
|------|------|-----------|
| `default_config.py` | 合并所有配置，提供统一接口 | `DEFAULT_CONFIG`, `PLATFORM_CONFIG` |
| `system_config.py` | 系统基础配置 | `ctrl_freq`, `gravity`, `watchdog`, `diagnostics` |
| `mpc_config.py` | MPC 控制器配置 | `horizon`, `weights`, `health_monitor`, `fallback`, `solver` |
| `safety_config.py` | 安全和约束配置 | `constraints`, `safety`, `state_machine`, `accel_filter` |
| `ekf_config.py` | EKF 状态估计配置 | `adaptive`, `measurement_noise`, `process_noise`, `anomaly_detection` |
| `attitude_config.py` | 姿态控制配置 | `mass`, `roll/pitch/yaw_rate_max`, `hover_*`, `thrust_*` |
| `modules_config.py` | 其他模块配置 | `consistency`, `transform`, `transition`, `backup` |
| `platform_config.py` | 平台运动学配置 | `active_dims`, `control_dims`, `constraints`, `output_frame` |
| `validation.py` | 配置验证工具 | `validate_config()`, `validate_logical_consistency()` |

### 配置验证规则

每个配置模块都定义了对应的验证规则：

```python
# 示例: MPC 配置验证规则
MPC_VALIDATION_RULES = {
    'mpc.horizon': (1, 100, 'MPC 预测时域'),
    'mpc.dt': (0.001, 1.0, 'MPC 时间步长 (秒)'),
    'mpc.weights.position': (0.0, None, 'MPC 位置权重'),
    # ...
}
```

---

## 核心模块详细说明

### core/ 目录文件

| 文件 | 功能 | 主要类/函数 |
|------|------|------------|
| `data_types.py` | 数据类型定义 | `Trajectory`, `ControlOutput`, `EstimatorOutput`, `DiagnosticsV2` |
| `enums.py` | 枚举定义 | `ControllerState`, `PlatformType`, `TransformStatus`, `HeadingMode` |
| `interfaces.py` | 抽象接口 | `IStateEstimator`, `ITrajectoryTracker`, `ISafetyMonitor` |
| `ros_compat.py` | ROS 兼容层 | `euler_from_quaternion()`, `quaternion_from_euler()`, `get_current_time()` |
| `velocity_smoother.py` | 速度平滑 | `VelocitySmoother`, `clip_velocity()` |
| `diagnostics_input.py` | 诊断输入类型 | `DiagnosticsInput` (强类型替代 Dict) |
| `logging_config.py` | 日志配置 | `get_logger()`, `configure_logging()` |

### VelocitySmoother 类

```python
class VelocitySmoother:
    """速度平滑器 - 限制控制命令的加速度"""
    
    def __init__(self, a_max, az_max, alpha_max, dt):
        # a_max: 最大水平加速度 (m/s²)
        # az_max: 最大垂直加速度 (m/s²)
        # alpha_max: 最大角加速度 (rad/s²)
        # dt: 时间步长 (s)
    
    def smooth(self, cmd, last_cmd) -> ControlOutput:
        """平滑控制命令 (向量限制水平速度)"""
    
    def smooth_to_stop(self, last_cmd, frame_id) -> ControlOutput:
        """平滑停止"""
```

### DiagnosticsInput 类

```python
@dataclass
class DiagnosticsInput:
    """诊断输入数据类 - 替代 Dict[str, Any]"""
    alpha: float = 1.0
    data_valid: bool = True
    mpc_health: Optional[MPCHealthStatus] = None
    mpc_success: bool = False
    odom_timeout: bool = False
    traj_timeout_exceeded: bool = False
    v_horizontal: float = 0.0
    vz: float = 0.0
    has_valid_data: bool = False
    tf2_critical: bool = False
    safety_failed: bool = False
    current_state: ControllerState = ControllerState.INIT
```

---

## 诊断模块详细说明

### DiagnosticsPublisher 类

```python
class DiagnosticsPublisher:
    """
    诊断发布器 - 负责诊断数据的收集、格式化和通过回调发布
    
    设计说明：
    - 本类不直接进行 ROS 发布，保持 universal_controller 的 ROS 无关性
    - ROS 消息发布由 controller_ros/io/publishers.py 中的 PublisherManager 负责
    - 通过回调机制将诊断数据传递给 ROS 层
    """
    
    def __init__(self, diagnostics_topic, cmd_topic):
        # 初始化回调列表 (线程安全)
        # 话题名称仅用于日志和状态查询
    
    def add_callback(self, callback):
        """添加诊断回调函数 (线程安全)"""
    
    def remove_callback(self, callback):
        """移除诊断回调函数 (线程安全)"""
    
    def publish(self, current_time, state, cmd, ...):
        """构建诊断数据并通过回调发布"""
    
    def get_last_published(self):
        """获取最后发布的诊断数据"""
```

**特性:**
- 线程安全的回调管理
- 自动移除连续失败超过 5 次的回调
- 保持 universal_controller 的 ROS 无关性

---

## 测试模块详细说明

### 测试文件分类

| 类别 | 文件 | 测试内容 |
|------|------|----------|
| 核心测试 | `test_core.py` | 数据类型、枚举、接口 |
| 组件测试 | `test_components.py` | 各组件单元测试 |
| 估计器测试 | `test_ekf_estimator.py` | EKF 状态估计器 |
| 跟踪器测试 | `test_trackers.py` | MPC 和 Pure Pursuit |
| 姿态测试 | `test_attitude_controller.py` | 四旋翼姿态控制 |
| 变换测试 | `test_tf2_transform.py`, `test_coordinate_transform.py` | TF2 和坐标变换 |
| 配置测试 | `test_config_validation.py`, `test_config_effects.py` | 配置验证和效果 |
| 诊断测试 | `test_diagnostics_input.py`, `test_diagnostics_publisher.py` | 诊断模块 |
| 集成测试 | `test_integration.py` | 端到端集成 |
| 回归测试 | `test_bug_fixes.py` | Bug 修复验证 |
| 可用性测试 | `test_system_usability.py` | 系统可用性 |

### 运行测试

```bash
# 运行所有测试
python universal_controller/tests/run_all_tests.py

# 运行单个测试文件
python -m pytest universal_controller/tests/test_core.py -v

# 运行特定测试
python -m pytest universal_controller/tests/test_ekf_estimator.py::TestAdaptiveEKF -v

# 运行带覆盖率
python -m pytest universal_controller/tests/ --cov=universal_controller --cov-report=html
```

---

## 代码统计

| 类别 | 文件数 | 说明 |
|------|--------|------|
| 配置模块 | 10 | system, mpc, safety, ekf, attitude, modules, platform, validation, default, __init__ |
| 核心模块 | 8 | data_types, enums, interfaces, ros_compat, velocity_smoother, diagnostics_input, logging_config, __init__ |
| 状态估计 | 2 | adaptive_ekf, __init__ |
| 轨迹跟踪 | 4 | mpc_controller, pure_pursuit, attitude_controller, __init__ |
| 一致性检查 | 2 | weighted_analyzer, __init__ |
| 安全模块 | 4 | safety_monitor, state_machine, timeout_monitor, __init__ |
| 健康监控 | 2 | mpc_health_monitor, __init__ |
| 坐标变换 | 2 | robust_transformer, __init__ |
| 平滑过渡 | 2 | smooth_transition, __init__ |
| 控制器管理 | 2 | controller_manager, __init__ |
| 诊断模块 | 2 | publisher, __init__ |
| Mock 模块 | 5 | ros_mock, data_mock, diagnostics_mock, test_data_generator, __init__ |
| Dashboard | 22 | main_window, data_source, models, styles, run_dashboard, 14 panels, 3 widgets |
| 消息定义 | 6 | 3 msg 文件, CMakeLists, package.xml, __init__ |
| 测试 | 16 | 14 测试文件, run_all_tests, __init__ |
| 根目录 | 4 | __init__, main, README, requirements |
| **总计** | **~87** | 不含 __pycache__ |

---

## 接口继承关系

```
IStateEstimator (ABC)
    └── AdaptiveEKFEstimator

ITrajectoryTracker (ABC)
    ├── MPCController
    └── PurePursuitController

IConsistencyChecker (ABC)
    └── WeightedConsistencyAnalyzer

ISafetyMonitor (ABC)
    └── BasicSafetyMonitor

ISmoothTransition (ABC)
    ├── ExponentialSmoothTransition
    └── LinearSmoothTransition

ICoordinateTransformer (ABC)
    └── RobustCoordinateTransformer

IAttitudeController (ABC)
    └── QuadrotorAttitudeController
```

---

## 数据流图

```
输入层:
  ┌─────────┐   ┌─────────────┐   ┌─────────┐
  │  Odom   │   │  Trajectory │   │   IMU   │
  └────┬────┘   └──────┬──────┘   └────┬────┘
       │               │               │
       ▼               ▼               ▼
处理层:
  ┌─────────────────────────────────────────┐
  │     TimeoutMonitor (monotonic clock)    │
  └─────────────────────────────────────────┘
       │               │               │
       ▼               ▼               ▼
  ┌─────────────────────────────────────────┐
  │         AdaptiveEKFEstimator            │
  │  predict() → update_odom() → update_imu()│
  │         (Joseph form update)            │
  └─────────────────────────────────────────┘
       │               │
       ▼               ▼
  ┌──────────────┐  ┌──────────────────────┐
  │ Consistency  │  │ CoordTransformer     │
  │   Analyzer   │  │ (TF2 + Fallback)     │
  └──────────────┘  └──────────────────────┘
       │               │
       ▼               ▼
  ┌─────────────────────────────────────────┐
  │    MPCController / PurePursuitController │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │           MPCHealthMonitor              │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │   SafetyMonitor (accel filtering α=0.3) │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │   StateMachine (fail counter + decay)   │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │          SmoothTransition               │
  └─────────────────────────────────────────┘
       │
       ▼
输出层:
  ┌─────────────────────────────────────────┐
  │        DiagnosticsPublisher             │
  │   (ROS 话题 + 回调函数，线程安全)         │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────┐   ┌─────────────────────┐
  │ ControlOutput│   │   DiagnosticsV2    │
  └─────────────┘   └─────────────────────┘
```

---

## 关键技术特性

| 特性 | 实现位置 | 说明 |
|------|----------|------|
| 单一时钟源 | 全局 | `time.monotonic()` 统一使用，避免系统时间跳变 |
| 加速度滤波 | safety_monitor.py | 一阶低通滤波 α=0.3，滑动窗口平均 |
| MPC fail counter | state_machine.py | 带衰减机制 (成功时 -0.5)，防止状态抖动 |
| 悬停检测 | attitude_controller.py | 滞回逻辑 (enter/exit factor)，防止频繁切换 |
| 四元数归一化 | ros_compat.py | 完整归一化，处理零向量情况 |
| Joseph 形式更新 | adaptive_ekf.py | 数值稳定的 EKF 协方差更新 |
| 配置验证 | validation.py | 范围检查 + 逻辑一致性检查 |
| 诊断发布 | diagnostics/publisher.py | 线程安全回调，numpy JSON 序列化 |
| 强类型诊断 | diagnostics_input.py | `DiagnosticsInput` 替代 `Dict[str, Any]` |
| 统一日志 | logging_config.py | 支持 ROS 和非 ROS 环境 |

---

## 坐标系说明

```
    base_link (机体坐标系)              odom (里程计坐标系)
    ┌───────────────┐                   ┌─────────────────────┐
    │       ↑ X     │                   │                     │
    │       │       │    坐标变换        │    机器人轨迹       │
    │    ←──┼──→    │  ───────────→     │    ○──○──○──○       │
    │     Y │       │  base_link→odom   │                     │
    │       ↓       │                   │    启动位置 ●       │
    └───────────────┘                   └─────────────────────┘

- base_link: 网络输出轨迹的坐标系 (局部坐标，当前位置为原点)
- odom: 控制器工作坐标系 (里程计坐标系，从启动位置累积)
- odom 就是你的"世界坐标系"，不需要建图
```

**控制输出坐标系:**
- 差速车/阿克曼车: `base_link` (vx, omega)
- 全向车/四旋翼: `odom` (vx, vy, omega)
